

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>common &mdash; VMTK TOOLS 0.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="VMTK TOOLS 0.1 documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../vmtktools_docs.html" class="icon icon-home"> VMTK TOOLS
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Using VMTK Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scripts.html">Documentation for the Python Scripts</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../vmtktools_docs.html">VMTK TOOLS</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../vmtktools_docs.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Module code</a> &raquo;</li>
      
    <li>common</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for common</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">vtk</span>
<span class="kn">from</span> <span class="nn">vmtk</span> <span class="kn">import</span> <span class="n">vtkvmtk</span><span class="p">,</span> <span class="n">vmtkscripts</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">vmtkpointselector</span> <span class="kn">import</span> <span class="o">*</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="kn">as</span> <span class="nn">la</span>
<span class="kn">import</span> <span class="nn">matlab.engine</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">listdir</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">argrelextrema</span><span class="p">,</span> <span class="n">gaussian</span><span class="p">,</span> <span class="n">resample</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">splrep</span><span class="p">,</span> <span class="n">splev</span>

<span class="c1"># Global array names</span>
<span class="n">radiusArrayName</span> <span class="o">=</span> <span class="s1">&#39;MaximumInscribedSphereRadius&#39;</span>
<span class="n">parallelTransportNormalsArrayName</span> <span class="o">=</span> <span class="s1">&#39;ParallelTransportNormals&#39;</span>
<span class="n">groupIDsArrayName</span> <span class="o">=</span> <span class="s2">&quot;GroupIds&quot;</span>
<span class="n">abscissasArrayName</span> <span class="o">=</span> <span class="s1">&#39;Abscissas&#39;</span>
<span class="n">clippingArrayName</span> <span class="o">=</span> <span class="s1">&#39;ClippingArray&#39;</span>
<span class="n">branchClippingArrayName</span> <span class="o">=</span> <span class="s1">&#39;BranchClippingArray&#39;</span>
<span class="n">distanceToTubeArrayName</span> <span class="o">=</span> <span class="s1">&#39;DistanceToTubeFunction&#39;</span>
<span class="n">closedArrayName</span> <span class="o">=</span> <span class="s1">&#39;ClosedSection&#39;</span>
<span class="n">eikonalSolutionArrayName</span> <span class="o">=</span> <span class="s1">&#39;EikonalSolutionArray&#39;</span>
<span class="n">edgeArrayName</span> <span class="o">=</span> <span class="s1">&#39;EdgeArray&#39;</span>
<span class="n">edgePCoordArrayName</span> <span class="o">=</span> <span class="s1">&#39;EdgePCoordArray&#39;</span>
<span class="n">costFunctionArrayName</span> <span class="o">=</span> <span class="s1">&#39;CostFunctionArray&#39;</span>

<span class="c1"># Options not availeble from commandline</span>
<span class="n">divergingRatioToSpacingTolerance</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">interpolationHalfSize</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">voronoiCoreCutOffThreshold</span> <span class="o">=</span> <span class="mf">0.75</span>
<span class="n">numberOfSplineAnalyzedPoints</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">phiValues</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
<span class="n">thetaStep</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="c1"># Shortcuts</span>
<span class="c1">#distance = vtk.vtkMath.Distance2BetweenPoints</span>
<span class="n">version</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkVersion</span><span class="p">()</span><span class="o">.</span><span class="n">GetVTKMajorVersion</span><span class="p">()</span>

<div class="viewcode-block" id="read_polydata"><a class="viewcode-back" href="../scripts.html#common.read_polydata">[docs]</a><span class="k">def</span> <span class="nf">read_polydata</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load the given file, and return a vtkPolyData object for it. </span>

<span class="sd">    Args:</span>
<span class="sd">        filename (str): Path to input file. </span>

<span class="sd">    Returns:</span>
<span class="sd">        polyData (vtkSTL/vtkPolyData/vtkXMLStructured/</span>
<span class="sd">                    vtkXMLRectilinearâˆ•vtkXMLPolydata/vtkXMLUnstructured/</span>
<span class="sd">                    vtkXMLImage/Tecplot): Output data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check if file exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Could not find file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

    <span class="c1"># Check filename format</span>
    <span class="n">fileType</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fileType</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;The file does not have an extension&#39;</span><span class="p">)</span>

    <span class="c1"># Get reader</span>
    <span class="k">if</span> <span class="n">fileType</span> <span class="o">==</span> <span class="s1">&#39;stl&#39;</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkSTLReader</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">MergingOn</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">fileType</span> <span class="o">==</span> <span class="s1">&#39;vtk&#39;</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataReader</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">fileType</span> <span class="o">==</span> <span class="s1">&#39;vtp&#39;</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">fileType</span> <span class="o">==</span> <span class="s1">&#39;vts&#39;</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLStructuredGridReader</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">fileType</span> <span class="o">==</span> <span class="s1">&#39;vtr&#39;</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLRectilinearGridReader</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">fileType</span> <span class="o">==</span> <span class="s1">&#39;vtu&#39;</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLUnstructuredGridReader</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">fileType</span> <span class="o">==</span> <span class="s2">&quot;vti&quot;</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLImageDataReader</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">fileType</span> <span class="o">==</span> <span class="s2">&quot;tec&quot;</span><span class="p">:</span>
        <span class="n">polyData</span> <span class="o">=</span> <span class="n">ReadTecplotSurfaceFile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">polyData</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unknown file type </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fileType</span><span class="p">)</span>

    <span class="c1"># Read</span>
    <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="n">polyData</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">polyData</span></div>


<div class="viewcode-block" id="write_polydata"><a class="viewcode-back" href="../scripts.html#common.write_polydata">[docs]</a><span class="k">def</span> <span class="nf">write_polydata</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write the given input data based on the file name extension.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_data (vtkSTLâˆ•vtkPolyData/vtkXMLStructured/</span>
<span class="sd">                    vtkXMLRectilinearâˆ•vtkXMLPolydata/vtkXMLUnstructured/</span>
<span class="sd">                    vtkXMLImage/Tecplot): Input data. </span>
<span class="sd">        filename (str): Save path location.    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check filename format</span>
    <span class="n">fileType</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fileType</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;The file does not have an extension&#39;</span><span class="p">)</span>

    <span class="c1"># Get writer</span>
    <span class="k">if</span> <span class="n">fileType</span> <span class="o">==</span> <span class="s1">&#39;stl&#39;</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkSTLWriter</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">fileType</span> <span class="o">==</span> <span class="s1">&#39;vtk&#39;</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataWriter</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">fileType</span> <span class="o">==</span> <span class="s1">&#39;vts&#39;</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLStructuredGridWriter</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">fileType</span> <span class="o">==</span> <span class="s1">&#39;vtr&#39;</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLRectilinearGridWriter</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">fileType</span> <span class="o">==</span> <span class="s1">&#39;vtp&#39;</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">fileType</span> <span class="o">==</span> <span class="s1">&#39;vtu&#39;</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLUnstructuredGridWriter</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">fileType</span> <span class="o">==</span> <span class="s2">&quot;vti&quot;</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLImageDataWriter</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">fileType</span> <span class="o">==</span> <span class="s2">&quot;tec&quot;</span><span class="p">:</span>
        <span class="n">WriteTecplotSurfaceFile</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unknown file type </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fileType</span><span class="p">)</span>

    <span class="c1"># Set filename and input</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

    <span class="c1"># Write</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">read_tecplot_surface_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

    <span class="c1"># Read title</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;TITLE&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

    <span class="c1"># Read array names</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;VARIABLES&#39;</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;VARIABLES&#39;</span><span class="p">:</span>
        <span class="n">arrayNames</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">arrayNames</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

    <span class="c1"># Read ZONE variables</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ZONE&#39;</span><span class="p">:</span>
        <span class="n">lineNid</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;N=&#39;</span><span class="p">)</span>
        <span class="n">lineN</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">lineNid</span><span class="p">:</span><span class="n">lineNid</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="n">lineNid</span><span class="p">:]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">numberOfNodes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lineN</span><span class="p">)</span>
        <span class="n">lineEid</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;E=&#39;</span><span class="p">)</span>
        <span class="n">lineE</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">lineEid</span><span class="p">:</span><span class="n">lineEid</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="n">lineEid</span><span class="p">:]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">numberOfElements</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lineE</span><span class="p">)</span>
        <span class="n">elementType</span> <span class="o">=</span> <span class="s1">&#39;TRIANGLE&#39;</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;ET=&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;TRIANGLE&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">elementType</span> <span class="o">=</span> <span class="s1">&#39;TRIANGLE&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;QUADRILATERAL&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">elementType</span> <span class="o">=</span> <span class="s1">&#39;QUADRILATERAL&#39;</span>

    <span class="c1"># Initialize vtk objects</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPoints</span><span class="p">()</span>
    <span class="n">cells</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCellArray</span><span class="p">()</span>
    <span class="n">points</span><span class="o">.</span><span class="n">SetNumberOfPoints</span><span class="p">(</span><span class="n">numberOfNodes</span><span class="p">)</span>
    <span class="n">surface</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">()</span>
    <span class="n">surface</span><span class="o">.</span><span class="n">SetPoints</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">surface</span><span class="o">.</span><span class="n">SetPolys</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span>

    <span class="c1"># Fill array object</span>
    <span class="k">for</span> <span class="n">arrayName</span> <span class="ow">in</span> <span class="n">arrayNames</span><span class="p">:</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkDoubleArray</span><span class="p">()</span>
        <span class="n">array</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">arrayName</span><span class="p">)</span>
        <span class="n">array</span><span class="o">.</span><span class="n">SetNumberOfTuples</span><span class="p">(</span><span class="n">numberOfNodes</span><span class="p">)</span>
        <span class="n">surface</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>

    <span class="c1"># Get rest of data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="c1"># Insert points</span>
    <span class="n">dataCounter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numberOfNodes</span><span class="p">):</span>
        <span class="n">point</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">dataCounter</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">dataCounter</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">dataCounter</span><span class="o">+</span><span class="mi">2</span><span class="p">])]</span>
        <span class="n">dataCounter</span> <span class="o">+=</span> <span class="mi">3</span>
        <span class="n">points</span><span class="o">.</span><span class="n">SetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">point</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arrayNames</span><span class="p">)):</span>
            <span class="n">surface</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">arrayNames</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">SetComponent</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">dataCounter</span><span class="p">]))</span>
            <span class="n">dataCounter</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># TODO: Is this necessary? It is not inserted into the surface</span>
    <span class="c1"># Insert ids</span>
    <span class="n">cellIds</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkIdList</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numberOfElements</span><span class="p">):</span>
        <span class="n">cellIds</span><span class="o">.</span><span class="n">Initialize</span><span class="p">()</span>
        <span class="n">cellIds</span><span class="o">.</span><span class="n">InsertNextId</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">dataCounter</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dataCounter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">cellIds</span><span class="o">.</span><span class="n">InsertNextId</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">dataCounter</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dataCounter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">cellIds</span><span class="o">.</span><span class="n">InsertNextId</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">dataCounter</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dataCounter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">elementType</span> <span class="o">==</span> <span class="s2">&quot;QUADRILATERAL&quot;</span><span class="p">:</span>
            <span class="n">cellIds</span><span class="o">.</span><span class="n">InsertNextId</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">dataCounter</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dataCounter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">cells</span><span class="o">.</span><span class="n">InsertNextCell</span><span class="p">(</span><span class="n">cellIds</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">surface</span>


<span class="k">def</span> <span class="nf">write_tecplot_surface_file</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="c1"># Triangulate surface</span>
    <span class="n">surface</span> <span class="o">=</span> <span class="n">triangulate_surface</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>

    <span class="c1"># Open file</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;VARIABLES = X,Y,Z&quot;</span>

    <span class="c1"># Get array</span>
    <span class="n">arrayNames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Surface</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetNumberOfArrays</span><span class="p">()):</span>
        <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Surface</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">arrayName</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">GetName</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">arrayName</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">arrayName</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">arrayNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arrayName</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">GetNumberOfComponents</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">arrayName</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">GetNumberOfComponents</span><span class="p">()):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">arrayName</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># Write header</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;ZONE N=</span><span class="si">%s</span><span class="s2">,E=</span><span class="si">%s</span><span class="s2">,F=FEPOINT,ET=TRIANGLE</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Surface</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()),</span>
             <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Surface</span><span class="o">.</span><span class="n">GetNumberOfCells</span><span class="p">()))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># Write coordintes and array</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Surface</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()):</span>
        <span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Surface</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arrayName</span> <span class="ow">in</span> <span class="n">arrayNames</span><span class="p">:</span>
            <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Surface</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">arrayName</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">GetNumberOfComponents</span><span class="p">()):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">GetComponent</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">))</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># Write conectivity(?) and ids</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Surface</span><span class="o">.</span><span class="n">GetNumberOfCells</span><span class="p">()):</span>
        <span class="n">cellPointIds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Surface</span><span class="o">.</span><span class="n">GetCell</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">GetPointIds</span><span class="p">()</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cellPointIds</span><span class="o">.</span><span class="n">GetNumberOfIds</span><span class="p">()):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cellPointIds</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">uncapp_surface</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">centerlines</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">clipspheres</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">extractor</span> <span class="o">=</span> <span class="n">vmtkscripts</span><span class="o">.</span><span class="n">vmtkEndpointExtractor</span><span class="p">()</span>
    <span class="n">extractor</span><span class="o">.</span><span class="n">Centerlines</span> <span class="o">=</span> <span class="n">centerlines</span>
    <span class="n">extractor</span><span class="o">.</span><span class="n">RadiusArrayName</span> <span class="o">=</span> <span class="n">radiusArrayName</span>
    <span class="n">extractor</span><span class="o">.</span><span class="n">GroupIdsArrayName</span> <span class="o">=</span> <span class="n">groupIDsArrayName</span>
    <span class="n">extractor</span><span class="o">.</span><span class="n">BlankingArrayName</span> <span class="o">=</span> <span class="n">branchClippingArrayName</span>
    <span class="n">extractor</span><span class="o">.</span><span class="n">NumberOfEndPointSpheres</span> <span class="o">=</span> <span class="n">clipspheres</span>
    <span class="n">extractor</span><span class="o">.</span><span class="n">Execute</span><span class="p">()</span>
    <span class="n">clipped_centerlines</span> <span class="o">=</span> <span class="n">extractor</span><span class="o">.</span><span class="n">Centerlines</span>

    <span class="n">clipper</span> <span class="o">=</span> <span class="n">vmtkscripts</span><span class="o">.</span><span class="n">vmtkBranchClipper</span><span class="p">()</span>
    <span class="n">clipper</span><span class="o">.</span><span class="n">Surface</span> <span class="o">=</span> <span class="n">surface</span>
    <span class="n">clipper</span><span class="o">.</span><span class="n">Centerlines</span> <span class="o">=</span> <span class="n">clipped_centerlines</span>
    <span class="n">clipper</span><span class="o">.</span><span class="n">RadiusArrayName</span> <span class="o">=</span> <span class="n">radiusArrayName</span>
    <span class="n">clipper</span><span class="o">.</span><span class="n">GroupIdsArrayName</span> <span class="o">=</span> <span class="n">groupIDsArrayName</span>
    <span class="n">clipper</span><span class="o">.</span><span class="n">BlankingArrayName</span> <span class="o">=</span> <span class="n">branchClippingArrayName</span>
    <span class="n">clipper</span><span class="o">.</span><span class="n">Execute</span><span class="p">()</span>
    <span class="n">surface</span> <span class="o">=</span> <span class="n">clipper</span><span class="o">.</span><span class="n">Surface</span>

    <span class="n">connector</span> <span class="o">=</span> <span class="n">vmtkscripts</span><span class="o">.</span><span class="n">vmtkSurfaceConnectivity</span><span class="p">()</span>
    <span class="n">connector</span><span class="o">.</span><span class="n">Surface</span> <span class="o">=</span> <span class="n">surface</span>
    <span class="n">connector</span><span class="o">.</span><span class="n">CleanOutput</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">connector</span><span class="o">.</span><span class="n">Execute</span><span class="p">()</span>
    <span class="n">surface</span> <span class="o">=</span> <span class="n">connector</span><span class="o">.</span><span class="n">Surface</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">write_polydata</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">surface</span>


<span class="k">def</span> <span class="nf">get_teams</span><span class="p">(</span><span class="n">dirpath</span><span class="p">):</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span> <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
    <span class="n">teams</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
            <span class="n">teams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">folder</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">teams</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">teams</span>


<span class="k">def</span> <span class="nf">make_voronoi_diagram</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">read_polydata</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="n">voronoi</span> <span class="o">=</span> <span class="n">vmtkscripts</span><span class="o">.</span><span class="n">vmtkDelaunayVoronoi</span><span class="p">()</span>
    <span class="n">voronoi</span><span class="o">.</span><span class="n">Surface</span> <span class="o">=</span> <span class="n">surface</span>
    <span class="n">voronoi</span><span class="o">.</span><span class="n">RemoveSubresolutionTetrahedra</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">voronoi</span><span class="o">.</span><span class="n">Execute</span><span class="p">()</span>

    <span class="n">write_polydata</span><span class="p">(</span><span class="n">voronoi</span><span class="o">.</span><span class="n">VoronoiDiagram</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">VoronoiDiagram</span>


<span class="k">def</span> <span class="nf">write_spheres</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sphere</span><span class="si">%s</span><span class="s2">.vtp&quot;</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="p">[</span><span class="n">base</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="k">if</span> <span class="n">radius</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">radius</span>
    <span class="k">for</span> <span class="n">counter</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
        <span class="n">sphere</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkSphereSource</span><span class="p">()</span>
        <span class="n">sphere</span><span class="o">.</span><span class="n">SetCenter</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
        <span class="n">sphere</span><span class="o">.</span><span class="n">SetPhiResolution</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">sphere</span><span class="o">.</span><span class="n">SetThetaResolution</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">sphere</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">radius</span><span class="p">[</span><span class="n">counter</span><span class="p">])</span>
        <span class="n">sphere_</span> <span class="o">=</span> <span class="n">sphere</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>

        <span class="n">write_polydata</span><span class="p">(</span><span class="n">sphere_</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">name</span> <span class="o">%</span> <span class="n">counter</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">get_tolerance</span><span class="p">(</span><span class="n">centerline</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">extract_single_line</span><span class="p">(</span><span class="n">centerline</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">get_curvilinear_coordinate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">length</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">length</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">divergingRatioToSpacingTolerance</span>

<span class="k">def</span> <span class="nf">get_relevant_outlets</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">):</span>
    <span class="c1"># Check if info exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="s2">&quot;info.txt&quot;</span><span class="p">)):</span>
        <span class="n">provide_relevant_outlets</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">)</span>

    <span class="c1"># Open info</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">get_parameters</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
    <span class="n">relevant_outlets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;relevant_outlet_&quot;</span><span class="p">):</span>
            <span class="n">relevant_outlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">relevant_outlets</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">relevant_outlets</span> <span class="o">=</span> <span class="n">provide_relevant_outlets</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">relevant_outlets</span>



<span class="k">def</span> <span class="nf">smooth_voronoi_diagram</span><span class="p">(</span><span class="n">voronoi</span><span class="p">,</span> <span class="n">centerlines</span><span class="p">,</span> <span class="n">smoothingFactor</span><span class="p">,</span>
                         <span class="n">no_smooth_cl</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">numberOfPoints</span> <span class="o">=</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span>

    <span class="n">threshold</span> <span class="o">=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">radiusArrayName</span><span class="p">,</span> <span class="n">centerlines</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">smoothingFactor</span><span class="p">)</span>
    <span class="n">locator</span> <span class="o">=</span> <span class="n">get_locator</span><span class="p">(</span><span class="n">centerlines</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">no_smooth_cl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">no_locator</span> <span class="o">=</span> <span class="n">get_locator</span><span class="p">(</span><span class="n">no_smooth_cl</span><span class="p">)</span>

    <span class="n">smoothedDiagram</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">()</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPoints</span><span class="p">()</span>
    <span class="n">cellArray</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCellArray</span><span class="p">()</span>
    <span class="n">radiusArrayNumpy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="p">)</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="p">):</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">radiusArrayName</span><span class="p">)</span><span class="o">.</span><span class="n">GetTuple1</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">id_</span> <span class="o">=</span> <span class="n">locator</span><span class="o">.</span><span class="n">FindClosestPoint</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
        <span class="n">cl_point</span> <span class="o">=</span> <span class="n">centerlines</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">distance</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">cl_point</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="o">*</span><span class="n">threshold</span><span class="p">[</span><span class="n">id_</span><span class="p">]:</span>
            <span class="n">points</span><span class="o">.</span><span class="n">InsertNextPoint</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="n">cellArray</span><span class="o">.</span><span class="n">InsertNextCell</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cellArray</span><span class="o">.</span><span class="n">InsertCellPoint</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
            <span class="n">radiusArrayNumpy</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">elif</span> <span class="n">no_smooth_cl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dist1</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">centerlines</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">id_</span><span class="p">))</span>
            <span class="n">id_1</span> <span class="o">=</span> <span class="n">no_locator</span><span class="o">.</span><span class="n">FindClosestPoint</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="n">dist2</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">no_smooth_cl</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">id_1</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">dist2</span> <span class="o">&lt;</span> <span class="n">dist1</span><span class="p">:</span>
                <span class="n">points</span><span class="o">.</span><span class="n">InsertNextPoint</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
                <span class="n">cellArray</span><span class="o">.</span><span class="n">InsertNextCell</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">cellArray</span><span class="o">.</span><span class="n">InsertCellPoint</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
                <span class="n">radiusArrayNumpy</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">radius</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">[</span><span class="n">id_</span><span class="p">]:</span>
                    <span class="n">points</span><span class="o">.</span><span class="n">InsertNextPoint</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
                    <span class="n">cellArray</span><span class="o">.</span><span class="n">InsertNextCell</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">cellArray</span><span class="o">.</span><span class="n">InsertCellPoint</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
                    <span class="n">radiusArrayNumpy</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">radius</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">[</span><span class="n">id_</span><span class="p">]:</span>
                <span class="n">points</span><span class="o">.</span><span class="n">InsertNextPoint</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
                <span class="n">cellArray</span><span class="o">.</span><span class="n">InsertNextCell</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">cellArray</span><span class="o">.</span><span class="n">InsertCellPoint</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
                <span class="n">radiusArrayNumpy</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">radiusArray</span> <span class="o">=</span> <span class="n">get_vtk_array</span><span class="p">(</span><span class="n">radiusArrayName</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="n">radiusArray</span><span class="o">.</span><span class="n">SetTuple1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">radiusArrayNumpy</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">smoothedDiagram</span><span class="o">.</span><span class="n">SetPoints</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">smoothedDiagram</span><span class="o">.</span><span class="n">SetVerts</span><span class="p">(</span><span class="n">cellArray</span><span class="p">)</span>
    <span class="n">smoothedDiagram</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">radiusArray</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">smoothedDiagram</span>


<span class="k">def</span> <span class="nf">get_curvilinear_coordinate</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">curv_coor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">pnt1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">pnt2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">curv_coor</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">pnt1</span> <span class="o">-</span> <span class="n">pnt2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">curv_coor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">curv_coor</span>


<span class="k">def</span> <span class="nf">merge_data</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
    <span class="n">appendFilter</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkAppendPolyData</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">input_</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="n">appendFilter</span><span class="o">.</span><span class="n">AddInputData</span><span class="p">(</span><span class="n">input_</span><span class="p">)</span>
    <span class="n">appendFilter</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">appendFilter</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">get_array</span><span class="p">(</span><span class="n">arrayName</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">line</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">(),</span> <span class="n">k</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">getData</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">arrayName</span><span class="p">)</span><span class="o">.</span><span class="n">GetTuple1</span>
    <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">getData</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">arrayName</span><span class="p">)</span><span class="o">.</span><span class="n">GetTuple2</span>
    <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">getData</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">arrayName</span><span class="p">)</span><span class="o">.</span><span class="n">GetTuple3</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()):</span>
        <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">getData</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">array</span>


<span class="k">def</span> <span class="nf">get_array_cell</span><span class="p">(</span><span class="n">arrayName</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">line</span><span class="o">.</span><span class="n">GetNumberOfCells</span><span class="p">(),</span> <span class="n">k</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">getData</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">arrayName</span><span class="p">)</span><span class="o">.</span><span class="n">GetTuple1</span>
    <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">getData</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">arrayName</span><span class="p">)</span><span class="o">.</span><span class="n">GetTuple2</span>
    <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">getData</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">arrayName</span><span class="p">)</span><span class="o">.</span><span class="n">GetTuple3</span>
    <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
        <span class="n">getData</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">arrayName</span><span class="p">)</span><span class="o">.</span><span class="n">GetTuple9</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">GetNumberOfCells</span><span class="p">()):</span>
        <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">getData</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">array</span>


<span class="c1"># TODO: Get bounds and compute polyballs based on that</span>
<span class="c1">#       bounds = surface.GetBounds()</span>
<span class="k">def</span> <span class="nf">create_new_surface</span><span class="p">(</span><span class="n">completeVoronoiDiagram</span><span class="p">,</span> <span class="n">polyBallImageSize</span><span class="o">=</span><span class="p">[</span><span class="mi">120</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">120</span><span class="p">]):</span>
    <span class="c1"># Get the x,y, and z range of the completeVoronoiDiagram</span>
    <span class="n">modeller</span> <span class="o">=</span> <span class="n">vtkvmtk</span><span class="o">.</span><span class="n">vtkvmtkPolyBallModeller</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">modeller</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">completeVoronoiDiagram</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">modeller</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">completeVoronoiDiagram</span><span class="p">)</span>
    <span class="n">modeller</span><span class="o">.</span><span class="n">SetRadiusArrayName</span><span class="p">(</span><span class="n">radiusArrayName</span><span class="p">)</span>
    <span class="n">modeller</span><span class="o">.</span><span class="n">UsePolyBallLineOff</span><span class="p">()</span>
    <span class="n">modeller</span><span class="o">.</span><span class="n">SetSampleDimensions</span><span class="p">(</span><span class="n">polyBallImageSize</span><span class="p">)</span>
    <span class="n">modeller</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

    <span class="c1"># Write the new surface</span>
    <span class="n">marchingCube</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkMarchingCubes</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">marchingCube</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">modeller</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">marchingCube</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">modeller</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
    <span class="n">marchingCube</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">marchingCube</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="n">envelope</span> <span class="o">=</span> <span class="n">marchingCube</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">envelope</span>


<span class="k">def</span> <span class="nf">get_relevant_outlets_tavel</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">):</span>
    <span class="c1"># Check if info exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="s2">&quot;info.txt&quot;</span><span class="p">)):</span>
        <span class="n">provide_relevant_outlets_tawss</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">)</span>

    <span class="c1"># Open info</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">get_parameters</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
    <span class="n">relevant_outlets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">inlet</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;tavel_relevant_outlet_&quot;</span><span class="p">):</span>
            <span class="n">relevant_outlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;tavel_inlet&quot;</span><span class="p">):</span>
            <span class="n">inlet</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">if</span> <span class="n">relevant_outlets</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">inlet</span><span class="p">,</span> <span class="n">relevant_outlets</span> <span class="o">=</span> <span class="n">provide_relevant_outlets_inlet_tavel</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inlet</span><span class="p">,</span> <span class="n">relevant_outlets</span>


<span class="k">def</span> <span class="nf">get_relevant_outlets_tawss</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">):</span>
    <span class="c1"># Check if info exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="s2">&quot;info.txt&quot;</span><span class="p">)):</span>
        <span class="n">provide_relevant_outlets_tawss</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">)</span>

    <span class="c1"># Open info</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">get_parameters</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
    <span class="n">relevant_outlets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">inlet</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;tawss_relevant_outlet_&quot;</span><span class="p">):</span>
            <span class="n">relevant_outlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;tawss_inlet&quot;</span><span class="p">):</span>
            <span class="n">inlet</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">if</span> <span class="n">relevant_outlets</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">inlet</span><span class="p">,</span> <span class="n">relevant_outlets</span> <span class="o">=</span> <span class="n">provide_relevant_outlets_inlet_tawss</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inlet</span><span class="p">,</span> <span class="n">relevant_outlets</span>


<span class="k">def</span> <span class="nf">get_relevant_outlets</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">):</span>
    <span class="c1"># Check if info exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="s2">&quot;info.txt&quot;</span><span class="p">)):</span>
        <span class="n">provide_relevant_outlets</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">)</span>

    <span class="c1"># Open info</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">get_parameters</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
    <span class="n">relevant_outlets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;relevant_outlet_&quot;</span><span class="p">):</span>
            <span class="n">relevant_outlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">relevant_outlets</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">relevant_outlets</span> <span class="o">=</span> <span class="n">provide_relevant_outlets</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">relevant_outlets</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">relevant_outlets</span>




<span class="k">def</span> <span class="nf">get_aneurysm_dome</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">,</span> <span class="n">anu_num</span><span class="p">):</span>
    <span class="c1"># Check if info exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="s2">&quot;info.txt&quot;</span><span class="p">)):</span>
        <span class="n">provide_aneurysm_points</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">)</span>

    <span class="c1"># Open info</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">get_parameters</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
    <span class="n">dome</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;aneurysm_&quot;</span><span class="p">):</span>
            <span class="n">dome</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># Recursive call</span>
    <span class="k">if</span> <span class="n">dome</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">dome</span> <span class="o">=</span> <span class="n">provide_aneurysm_points</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dome</span><span class="p">[</span><span class="n">anu_num</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">centerline_div</span><span class="p">(</span><span class="n">centerline1</span><span class="p">,</span> <span class="n">centerline2</span><span class="p">,</span> <span class="n">tol</span><span class="p">):</span>
    <span class="c1"># Find clipping points</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">centerline1</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">(),</span> <span class="n">centerline2</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">())</span>
    <span class="n">get_point1</span> <span class="o">=</span> <span class="n">centerline1</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoint</span>
    <span class="n">get_point2</span> <span class="o">=</span> <span class="n">centerline2</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoint</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">distance_between_points</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">get_point1</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">get_point2</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">distance_between_points</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">i</span>


<span class="k">def</span> <span class="nf">provide_relevant_outlets_tavel</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">dir_path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="c1"># Fix surface</span>
    <span class="n">cleaned_surface</span> <span class="o">=</span> <span class="n">surface_cleaner</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
    <span class="n">triangulated_surface</span> <span class="o">=</span> <span class="n">triangulate_surface</span><span class="p">(</span><span class="n">cleaned_surface</span><span class="p">)</span>

    <span class="c1"># Select seeds</span>
    <span class="n">SeedSelector</span> <span class="o">=</span> <span class="n">vmtkPickPointSeedSelector</span><span class="p">()</span>
    <span class="n">SeedSelector</span><span class="o">.</span><span class="n">SetSurface</span><span class="p">(</span><span class="n">triangulated_surface</span><span class="p">)</span>
    <span class="n">SeedSelector</span><span class="o">.</span><span class="n">Execute</span><span class="p">()</span>

    <span class="n">aneurysmSeedIds</span> <span class="o">=</span> <span class="n">SeedSelector</span><span class="o">.</span><span class="n">GetTargetSeedIds</span><span class="p">()</span>
    <span class="n">get_point</span> <span class="o">=</span> <span class="n">surface</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoint</span>
    <span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">get_point</span><span class="p">(</span><span class="n">aneurysmSeedIds</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">aneurysmSeedIds</span><span class="o">.</span><span class="n">GetNumberOfIds</span><span class="p">())]</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">dir_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;tavel_inlet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)):</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;tavel_relevant_outlet_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">write_parameters</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>


<span class="k">def</span> <span class="nf">provide_relevant_outlets_tawss</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">dir_path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="c1"># Fix surface</span>
    <span class="n">cleaned_surface</span> <span class="o">=</span> <span class="n">surface_cleaner</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
    <span class="n">triangulated_surface</span> <span class="o">=</span> <span class="n">triangulate_surface</span><span class="p">(</span><span class="n">cleaned_surface</span><span class="p">)</span>

    <span class="c1"># Select seeds</span>
    <span class="n">SeedSelector</span> <span class="o">=</span> <span class="n">vmtkPickPointSeedSelector</span><span class="p">()</span>
    <span class="n">SeedSelector</span><span class="o">.</span><span class="n">SetSurface</span><span class="p">(</span><span class="n">triangulated_surface</span><span class="p">)</span>
    <span class="n">SeedSelector</span><span class="o">.</span><span class="n">Execute</span><span class="p">()</span>

    <span class="n">aneurysmSeedIds</span> <span class="o">=</span> <span class="n">SeedSelector</span><span class="o">.</span><span class="n">GetTargetSeedIds</span><span class="p">()</span>
    <span class="n">get_point</span> <span class="o">=</span> <span class="n">surface</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoint</span>
    <span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">get_point</span><span class="p">(</span><span class="n">aneurysmSeedIds</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">aneurysmSeedIds</span><span class="o">.</span><span class="n">GetNumberOfIds</span><span class="p">())]</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">dir_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;tawss_inlet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)):</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;tawss_relevant_outlet_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">write_parameters</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

<span class="k">def</span> <span class="nf">provide_relevant_outlets</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">dir_path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="c1"># Fix surface</span>
    <span class="n">cleaned_surface</span> <span class="o">=</span> <span class="n">surface_cleaner</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
    <span class="n">triangulated_surface</span> <span class="o">=</span> <span class="n">triangulate_surface</span><span class="p">(</span><span class="n">cleaned_surface</span><span class="p">)</span>

    <span class="c1"># Select seeds</span>
    <span class="n">SeedSelector</span> <span class="o">=</span> <span class="n">vmtkPickPointSeedSelector</span><span class="p">()</span>
    <span class="n">SeedSelector</span><span class="o">.</span><span class="n">SetSurface</span><span class="p">(</span><span class="n">triangulated_surface</span><span class="p">)</span>
    <span class="n">SeedSelector</span><span class="o">.</span><span class="n">Execute</span><span class="p">()</span>

    <span class="n">aneurysmSeedIds</span> <span class="o">=</span> <span class="n">SeedSelector</span><span class="o">.</span><span class="n">GetTargetSeedIds</span><span class="p">()</span>
    <span class="n">get_point</span> <span class="o">=</span> <span class="n">surface</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoint</span>
    <span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">get_point</span><span class="p">(</span><span class="n">aneurysmSeedIds</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">aneurysmSeedIds</span><span class="o">.</span><span class="n">GetNumberOfIds</span><span class="p">())]</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">dir_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)):</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;relevant_outlet_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">write_parameters</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">points</span>


<span class="k">def</span> <span class="nf">provide_aneurysm_points</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">dir_path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="c1"># Fix surface</span>
    <span class="n">cleaned_surface</span> <span class="o">=</span> <span class="n">surface_cleaner</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
    <span class="n">triangulated_surface</span> <span class="o">=</span> <span class="n">triangulate_surface</span><span class="p">(</span><span class="n">cleaned_surface</span><span class="p">)</span>

    <span class="c1"># Select seeds</span>
    <span class="n">SeedSelector</span> <span class="o">=</span> <span class="n">vmtkPickPointSeedSelector</span><span class="p">()</span>
    <span class="n">SeedSelector</span><span class="o">.</span><span class="n">SetSurface</span><span class="p">(</span><span class="n">triangulated_surface</span><span class="p">)</span>
    <span class="n">SeedSelector</span><span class="o">.</span><span class="n">Execute</span><span class="p">()</span>

    <span class="n">aneurysmSeedIds</span> <span class="o">=</span> <span class="n">SeedSelector</span><span class="o">.</span><span class="n">GetTargetSeedIds</span><span class="p">()</span>
    <span class="n">get_point</span> <span class="o">=</span> <span class="n">surface</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoint</span>
    <span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">get_point</span><span class="p">(</span><span class="n">aneurysmSeedIds</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">aneurysmSeedIds</span><span class="o">.</span><span class="n">GetNumberOfIds</span><span class="p">())]</span>

    <span class="k">if</span> <span class="n">dir_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;number_of_aneurysms&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)}</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)):</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;aneurysm_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">write_parameters</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">points</span>



<span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">centerline</span><span class="p">,</span> <span class="n">centerline_bif</span><span class="p">,</span> <span class="n">tol</span><span class="p">):</span>
    <span class="c1"># Sort centerline to start at inlet</span>
    <span class="n">cl1</span> <span class="o">=</span> <span class="n">extract_single_line</span><span class="p">(</span><span class="n">centerline</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cl2</span> <span class="o">=</span> <span class="n">extract_single_line</span><span class="p">(</span><span class="n">centerline</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">centerline</span> <span class="o">=</span> <span class="n">merge_data</span><span class="p">([</span><span class="n">cl1</span><span class="p">,</span><span class="n">cl2</span><span class="p">])</span>

    <span class="c1"># Declear variables before loop incase values are not found</span>
    <span class="n">diverging_point_ID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">diverging_point</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
    <span class="n">diverging_point_MISR</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">clipping_point_ID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">clipping_point</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bif&quot;</span><span class="p">:{},</span> <span class="mi">0</span><span class="p">:{},</span> <span class="mi">1</span><span class="p">:{}}</span>

    <span class="c1"># List of points conected to ID</span>
    <span class="n">points_ids_0</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkIdList</span><span class="p">()</span>
    <span class="n">points_ids_1</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkIdList</span><span class="p">()</span>

    <span class="c1"># One is the branch to the left and the other is the one to the right</span>
    <span class="n">centerline</span><span class="o">.</span><span class="n">GetCellPoints</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">points_ids_0</span><span class="p">)</span>
    <span class="n">centerline</span><span class="o">.</span><span class="n">GetCellPoints</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">points_ids_1</span><span class="p">)</span>
    <span class="c1"># Find lower clipping point</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">points_ids_0</span><span class="o">.</span><span class="n">GetNumberOfIds</span><span class="p">(),</span> <span class="n">points_ids_1</span><span class="o">.</span><span class="n">GetNumberOfIds</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">cell_point_0</span> <span class="o">=</span> <span class="n">centerline</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">points_ids_0</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">cell_point_1</span> <span class="o">=</span> <span class="n">centerline</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">points_ids_1</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        
        <span class="n">distance_between_points</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">cell_point_0</span><span class="p">,</span> <span class="n">cell_point_1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">distance_between_points</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="n">tmpI</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">point_ID_0</span> <span class="o">=</span> <span class="n">points_ids_0</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">point_ID_1</span> <span class="o">=</span> <span class="n">points_ids_1</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">centerline</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">point_ID_0</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">centerline</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">radiusArrayName</span><span class="p">)</span><span class="o">.</span><span class="n">GetTuple1</span><span class="p">(</span><span class="n">point_ID_0</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="n">end</span><span class="p">,</span> <span class="n">r_end</span> <span class="o">=</span> <span class="n">move_past_sphere</span><span class="p">(</span><span class="n">centerline</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">point_ID_0</span><span class="p">,</span> <span class="n">step</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;bif&quot;</span><span class="p">][</span><span class="s2">&quot;end_point&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;bif&quot;</span><span class="p">][</span><span class="s2">&quot;r_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_end</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;bif&quot;</span><span class="p">][</span><span class="s2">&quot;div_point&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">center</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;bif&quot;</span><span class="p">][</span><span class="s2">&quot;ID_div&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">point_ID_0</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;bif&quot;</span><span class="p">][</span><span class="s2">&quot;i_div&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpI</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;bif&quot;</span><span class="p">][</span><span class="s2">&quot;r_div&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>

    <span class="c1"># Find the diverging points for the bifurcation</span>
    <span class="c1"># continue further downstream in each direction and stop when</span>
    <span class="c1"># a point is closer than tol, then move point MISR * X</span>
    <span class="n">locator</span> <span class="o">=</span> <span class="n">get_locator</span><span class="p">(</span><span class="n">centerline_bif</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">counter</span><span class="p">,</span> <span class="n">point_ids</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">points_ids_0</span><span class="p">,</span> <span class="n">points_ids_1</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tmpI</span><span class="p">,</span> <span class="n">point_ids</span><span class="o">.</span><span class="n">GetNumberOfIds</span><span class="p">(),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">tmp_point</span> <span class="o">=</span> <span class="n">centerline</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">point_ids</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">closest_point_ID</span> <span class="o">=</span> <span class="n">locator</span><span class="o">.</span><span class="n">FindClosestPoint</span><span class="p">(</span><span class="n">tmp_point</span><span class="p">)</span>
            <span class="n">closest_point</span> <span class="o">=</span> <span class="n">centerline_bif</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">closest_point_ID</span><span class="p">)</span>
            <span class="n">distance_between_points</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">tmp_point</span><span class="p">,</span> <span class="n">closest_point</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">if</span> <span class="n">distance_between_points</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="n">point_ID</span> <span class="o">=</span> <span class="n">point_ids</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">center</span> <span class="o">=</span> <span class="n">centerline</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">point_ID</span><span class="p">)</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">centerline</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">radiusArrayName</span><span class="p">)</span><span class="o">.</span><span class="n">GetTuple1</span><span class="p">(</span><span class="n">point_ID</span><span class="p">)</span>
                <span class="k">break</span>
        
        <span class="n">end</span><span class="p">,</span> <span class="n">r_end</span> <span class="o">=</span> <span class="n">move_past_sphere</span><span class="p">(</span><span class="n">centerline</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">point_ID</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">point_ID</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="n">counter</span><span class="p">][</span><span class="s2">&quot;end_point&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end</span>
        <span class="n">data</span><span class="p">[</span><span class="n">counter</span><span class="p">][</span><span class="s2">&quot;r_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_end</span>
        <span class="n">data</span><span class="p">[</span><span class="n">counter</span><span class="p">][</span><span class="s2">&quot;r_div&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
        <span class="n">data</span><span class="p">[</span><span class="n">counter</span><span class="p">][</span><span class="s2">&quot;ID_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">locator</span><span class="o">.</span><span class="n">FindClosestPoint</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">counter</span><span class="p">][</span><span class="s2">&quot;end_point&quot;</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="n">counter</span><span class="p">][</span><span class="s2">&quot;ID_div&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">locator</span><span class="o">.</span><span class="n">FindClosestPoint</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="n">counter</span><span class="p">][</span><span class="s2">&quot;div_point&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">center</span>
        
    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">old_get_data_rotation</span><span class="p">(</span><span class="n">centerline_bif</span><span class="p">,</span> <span class="n">centerline_dau1</span><span class="p">,</span> <span class="n">centerline_dau2</span><span class="p">,</span> <span class="n">tol</span><span class="p">,</span> <span class="n">aneurysm_type</span><span class="p">):</span>
    <span class="c1"># Declear variables before loop if values are not found</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bif&quot;</span><span class="p">:{},</span> <span class="s2">&quot;dau1&quot;</span><span class="p">:{},</span> <span class="s2">&quot;dau2&quot;</span><span class="p">:{}}</span>

    <span class="c1"># List of points conected to ID</span>
    <span class="n">points_ids_0</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkIdList</span><span class="p">()</span>
    <span class="n">points_ids_1</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkIdList</span><span class="p">()</span>

    <span class="n">data_list</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;dau1&quot;</span><span class="p">,</span> <span class="n">centerline_dau1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;dau2&quot;</span><span class="p">,</span> <span class="n">centerline_dau2</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;bif&quot;</span><span class="p">,</span> <span class="n">centerline_bif</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">centerline</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">centerline</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">continue</span>
        <span class="c1"># One is the branch to the left and the other is the one to the right</span>
        <span class="n">centerline</span><span class="o">.</span><span class="n">GetCellPoints</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">points_ids_0</span><span class="p">)</span>
        <span class="n">centerline</span><span class="o">.</span><span class="n">GetCellPoints</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">points_ids_1</span><span class="p">)</span>

        <span class="c1"># Find clipping points</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">points_ids_0</span><span class="o">.</span><span class="n">GetNumberOfIds</span><span class="p">(),</span> <span class="n">points_ids_1</span><span class="o">.</span><span class="n">GetNumberOfIds</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
            <span class="n">cell_point_0</span> <span class="o">=</span> <span class="n">centerline</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">points_ids_0</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">cell_point_1</span> <span class="o">=</span> <span class="n">centerline</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">points_ids_1</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

            <span class="n">distance_between_points</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">cell_point_0</span><span class="p">,</span> <span class="n">cell_point_1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">distance_between_points</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="n">tmpI</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">point_ID_0</span> <span class="o">=</span> <span class="n">points_ids_0</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">point_ID_1</span> <span class="o">=</span> <span class="n">points_ids_1</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">center</span> <span class="o">=</span> <span class="n">centerline</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">point_ID_0</span><span class="p">)</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">centerline</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">radiusArrayName</span><span class="p">)</span><span class="o">.</span><span class="n">GetTuple1</span><span class="p">(</span><span class="n">point_ID_0</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="n">end</span><span class="p">,</span> <span class="n">r_end</span> <span class="o">=</span> <span class="n">move_past_sphere</span><span class="p">(</span><span class="n">centerline</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">point_ID_0</span><span class="p">,</span>
                                        <span class="n">stop</span><span class="o">=</span><span class="n">point_ID_0</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;end_point&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end</span>
        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;r_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_end</span>
        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;div_point&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">center</span>
        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;ID_div&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">point_ID_0</span>
        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;i_div&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpI</span>
        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;r_div&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">get_data_rotation</span><span class="p">(</span><span class="n">centerline_par</span><span class="p">,</span> <span class="n">centerline_dau1</span><span class="p">,</span> <span class="n">centerline_dau2</span><span class="p">,</span> <span class="n">tol</span><span class="p">,</span> <span class="n">aneurysm_type</span><span class="p">):</span>
    <span class="c1"># Declear variables before loop if values are not found</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dau1&quot;</span><span class="p">:{},</span> <span class="s2">&quot;dau2&quot;</span><span class="p">:{}}</span>

    <span class="c1"># List of points conected to ID</span>
    <span class="n">points_ids_0</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkIdList</span><span class="p">()</span>
    <span class="n">points_ids_1</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkIdList</span><span class="p">()</span>

    <span class="n">data_list</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;dau1&quot;</span><span class="p">,</span> <span class="n">centerline_dau1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;dau2&quot;</span><span class="p">,</span> <span class="n">centerline_dau2</span><span class="p">)]</span>

    <span class="c1"># Additional point for terminal</span>
    <span class="k">if</span> <span class="n">aneurysm_type</span> <span class="o">==</span> <span class="s2">&quot;terminal&quot;</span><span class="p">:</span>
        <span class="n">data_list</span> <span class="o">+=</span> <span class="p">[(</span><span class="s2">&quot;par&quot;</span><span class="p">,</span> <span class="n">centerline_par</span><span class="p">)]</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;par&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">centerline</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">centerline</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">continue</span>
        <span class="c1"># One is the branch to the left and the other is the one to the right</span>
        <span class="n">centerline</span><span class="o">.</span><span class="n">GetCellPoints</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">points_ids_0</span><span class="p">)</span>
        <span class="n">centerline</span><span class="o">.</span><span class="n">GetCellPoints</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">points_ids_1</span><span class="p">)</span>

        <span class="c1"># Find clipping points</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">points_ids_0</span><span class="o">.</span><span class="n">GetNumberOfIds</span><span class="p">(),</span> <span class="n">points_ids_1</span><span class="o">.</span><span class="n">GetNumberOfIds</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
            <span class="n">cell_point_0</span> <span class="o">=</span> <span class="n">centerline</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">points_ids_0</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">cell_point_1</span> <span class="o">=</span> <span class="n">centerline</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">points_ids_1</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

            <span class="n">distance_between_points</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">cell_point_0</span><span class="p">,</span> <span class="n">cell_point_1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">distance_between_points</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="n">tmpI</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">point_ID_0</span> <span class="o">=</span> <span class="n">points_ids_0</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">point_ID_1</span> <span class="o">=</span> <span class="n">points_ids_1</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">center</span> <span class="o">=</span> <span class="n">centerline</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">point_ID_0</span><span class="p">)</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">centerline</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">radiusArrayName</span><span class="p">)</span><span class="o">.</span><span class="n">GetTuple1</span><span class="p">(</span><span class="n">point_ID_0</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="n">end</span><span class="p">,</span> <span class="n">r_end</span> <span class="o">=</span> <span class="n">move_past_sphere</span><span class="p">(</span><span class="n">centerline</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">point_ID_0</span><span class="p">,</span>
                                        <span class="n">stop</span><span class="o">=</span><span class="n">point_ID_0</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;end_point&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end</span>
        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;r_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_end</span>
        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;div_point&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">center</span>
        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;ID_div&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">point_ID_0</span>
        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;i_div&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpI</span>
        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;r_div&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">write_points</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="n">pointSet</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">()</span>
    <span class="n">cellArray</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCellArray</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()):</span>
        <span class="n">cellArray</span><span class="o">.</span><span class="n">InsertNextCell</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cellArray</span><span class="o">.</span><span class="n">InsertCellPoint</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="n">pointSet</span><span class="o">.</span><span class="n">SetPoints</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">pointSet</span><span class="o">.</span><span class="n">SetVerts</span><span class="p">(</span><span class="n">cellArray</span><span class="p">)</span>

    <span class="n">write_polydata</span><span class="p">(</span><span class="n">pointSet</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>


<div class="viewcode-block" id="surface_cleaner"><a class="viewcode-back" href="../scripts.html#common.surface_cleaner">[docs]</a><span class="k">def</span> <span class="nf">surface_cleaner</span><span class="p">(</span><span class="n">surface</span><span class="p">):</span>
    <span class="s2">&quot;Clean surface&quot;</span>
    <span class="n">surfaceCleaner</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCleanPolyData</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">surfaceCleaner</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">surfaceCleaner</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
    <span class="n">surfaceCleaner</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">surfaceCleaner</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">get_area</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
    <span class="c1"># Check if info exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="s2">&quot;info.txt&quot;</span><span class="p">)):</span>
        <span class="n">compute_centers</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">)</span>

    <span class="c1"># Open info</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">get_parameters</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
    <span class="n">outlets_area</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;inlet_area&quot;</span><span class="p">:</span>
            <span class="n">inlet_area</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="s2">&quot;outlet&quot;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="s2">&quot;area&quot;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="s2">&quot;relevant&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">outlets_area</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outlets_area</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">outlet_area</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outlets_area</span><span class="p">)):</span>
            <span class="n">outlet_area</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;outlet</span><span class="si">%d</span><span class="s2">_area&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">inlet_area</span><span class="p">,</span> <span class="n">outlet_area</span>


<span class="k">def</span> <span class="nf">get_centers</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">,</span> <span class="n">flowext</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="c1"># Check if info exists</span>
    <span class="k">if</span> <span class="n">flowext</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="s2">&quot;info.txt&quot;</span><span class="p">)):</span>
        <span class="n">compute_centers</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">)</span>

    <span class="c1"># Open info</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">get_parameters</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
    <span class="n">outlets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">inlet</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;inlet&quot;</span><span class="p">:</span>
            <span class="n">inlet</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="s2">&quot;outlet&quot;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="s2">&quot;area&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="s2">&quot;relevant&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">outlets</span> <span class="o">+=</span> <span class="n">value</span>

    <span class="n">num_outlets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">outlets</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span>
    <span class="k">if</span> <span class="n">num_outlets</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">outlets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_outlets</span><span class="p">):</span>
            <span class="n">outlets</span> <span class="o">+=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;outlet</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">inlet</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">and</span> <span class="n">outlets</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">inlet</span><span class="p">,</span> <span class="n">outlets</span> <span class="o">=</span> <span class="n">compute_centers</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inlet</span><span class="p">,</span> <span class="n">outlets</span>


<div class="viewcode-block" id="triangulate_surface"><a class="viewcode-back" href="../scripts.html#common.triangulate_surface">[docs]</a><span class="k">def</span> <span class="nf">triangulate_surface</span><span class="p">(</span><span class="n">surface</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Triangulate surface or polygon(?)&quot;&quot;&quot;</span>
    <span class="n">surfaceTriangulator</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkTriangleFilter</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">surfaceTriangulator</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">surfaceTriangulator</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
    <span class="n">surfaceTriangulator</span><span class="o">.</span><span class="n">PassLinesOff</span><span class="p">()</span>
    <span class="n">surfaceTriangulator</span><span class="o">.</span><span class="n">PassVertsOff</span><span class="p">()</span>
    <span class="n">surfaceTriangulator</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">surfaceTriangulator</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">geometry_filter</span><span class="p">(</span><span class="n">unstructured_grid</span><span class="p">):</span>
     <span class="c1"># Convert unstructured grid to polydata</span>
    <span class="nb">filter</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkGeometryFilter</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="nb">filter</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">unstructured_grid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">filter</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">unstructured_grid</span><span class="p">)</span>
    <span class="nb">filter</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="n">polydata</span> <span class="o">=</span> <span class="nb">filter</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">polydata</span>


<span class="k">def</span> <span class="nf">threshold</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;between&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># source = 1 uses cell data as input</span>
    <span class="c1"># source = 0 uses point data as input</span>

    <span class="c1"># Apply threshold</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkThreshold</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">threshold</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">threshold</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="o">==</span><span class="s2">&quot;between&quot;</span><span class="p">:</span>
        <span class="n">threshold</span><span class="o">.</span><span class="n">ThresholdBetween</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;lower&quot;</span><span class="p">:</span>
        <span class="n">threshold</span><span class="o">.</span><span class="n">ThresholdByLower</span><span class="p">(</span><span class="n">lower</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;upper&quot;</span><span class="p">:</span>
        <span class="n">threshold</span><span class="o">.</span><span class="n">ThresholdByUpper</span><span class="p">(</span><span class="n">upper</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(((</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is not a threshold type. Pleace chose from: upper, lower&quot;</span> <span class="o">+</span> \
              <span class="s2">&quot;, or between&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="nb">type</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">threshold</span><span class="o">.</span><span class="n">SetInputArrayToProcess</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">threshold</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="n">surface</span> <span class="o">=</span> <span class="n">threshold</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>

    <span class="c1"># Convert to polydata</span>
    <span class="n">surface</span> <span class="o">=</span> <span class="n">geometryFilter</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">surface</span>


<div class="viewcode-block" id="compute_area"><a class="viewcode-back" href="../scripts.html#common.compute_area">[docs]</a><span class="k">def</span> <span class="nf">compute_area</span><span class="p">(</span><span class="n">surface</span><span class="p">):</span>
    <span class="s2">&quot;Compute area of polydata&quot;</span>
    <span class="n">mass</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkMassProperties</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">mass</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mass</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mass</span><span class="o">.</span><span class="n">GetSurfaceArea</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">uncapp_surface_old</span><span class="p">(</span><span class="n">surface</span><span class="p">):</span>
    <span class="c1"># Add-hoc method for removing capps on surfaces</span>
    <span class="c1"># This could proboly be highly improved, but is sufficient for now.</span>

    <span class="c1"># Get cell normals</span>
    <span class="n">normal_generator</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataNormals</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">normal_generator</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">normal_generator</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
    <span class="n">normal_generator</span><span class="o">.</span><span class="n">ComputePointNormalsOff</span><span class="p">()</span>
    <span class="n">normal_generator</span><span class="o">.</span><span class="n">ComputeCellNormalsOn</span><span class="p">()</span>
    <span class="n">normal_generator</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="n">cell_normals</span> <span class="o">=</span> <span class="n">normal_generator</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>

    <span class="c1"># Compute gradients of the normals</span>
    <span class="n">gradients_generator</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkGradientFilter</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">gradients_generator</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">cell_normals</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gradients_generator</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">cell_normals</span><span class="p">)</span>
    <span class="n">gradients_generator</span><span class="o">.</span><span class="n">SetInputArrayToProcess</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Normals&quot;</span><span class="p">)</span>
    <span class="n">gradients_generator</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="n">gradients</span> <span class="o">=</span> <span class="n">gradients_generator</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>

    <span class="c1"># Compute the magnitude of the gradient</span>
    <span class="n">gradients_array</span> <span class="o">=</span> <span class="n">get_array_cell</span><span class="p">(</span><span class="s2">&quot;Gradients&quot;</span><span class="p">,</span> <span class="n">gradients</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">gradients_magnitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gradients_array</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Mark all cells with a gradient magnitude less then 0.1</span>
    <span class="n">end_capp_array</span> <span class="o">=</span> <span class="n">gradients_magnitude</span> <span class="o">&lt;</span> <span class="mf">0.08</span>
    <span class="n">end_capp_vtk</span> <span class="o">=</span> <span class="n">get_vtk_array</span><span class="p">(</span><span class="s2">&quot;Gradients_mag&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end_capp_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">end_capp_array</span><span class="p">):</span>
        <span class="n">end_capp_vtk</span><span class="o">.</span><span class="n">SetTuple</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">[</span><span class="n">p</span><span class="p">])</span>
    <span class="n">gradients</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">end_capp_vtk</span><span class="p">)</span>

    <span class="c1"># Extract capps</span>
    <span class="n">end_capps</span> <span class="o">=</span> <span class="n">threshold</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="s2">&quot;Gradients_mag&quot;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;between&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Get connectivity</span>
    <span class="n">end_capps_connectivity</span> <span class="o">=</span> <span class="n">getConnectivity</span><span class="p">(</span><span class="n">end_capps</span><span class="p">)</span>
    <span class="n">region_array</span> <span class="o">=</span> <span class="n">get_array</span><span class="p">(</span><span class="s2">&quot;RegionId&quot;</span><span class="p">,</span> <span class="n">end_capps_connectivity</span><span class="p">)</span>

    <span class="c1"># Compute area for each region</span>
    <span class="n">area</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">circleness</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">regions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">centers_edge</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">limit</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">region_array</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">threshold</span><span class="p">(</span><span class="n">end_capps_connectivity</span><span class="p">,</span> <span class="s2">&quot;RegionId&quot;</span><span class="p">,</span>  <span class="n">lower</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">limit</span><span class="p">),</span>
                            <span class="n">upper</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">limit</span><span class="p">),</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;between&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">circ</span><span class="p">,</span> <span class="n">center</span> <span class="o">=</span> <span class="n">computeCircleness</span><span class="p">(</span><span class="n">regions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">circleness</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">circ</span><span class="p">)</span>
        <span class="n">centers_edge</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
        <span class="n">area</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compute_area</span><span class="p">(</span><span class="n">regions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="c1"># Only keep outlets with circleness &lt; 3 and area &gt; 0.3 mm^2</span>
    <span class="n">circleness_IDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">circleness</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">region_IDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">area</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">)</span>
    <span class="n">regions</span> <span class="o">=</span> <span class="p">[</span><span class="n">regions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">region_IDs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">circleness_IDs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">centers_edge</span> <span class="o">=</span> <span class="p">[</span><span class="n">centers_edge</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">region_IDs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">circleness_IDs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="c1"># Mark the outlets on the original surface</span>
    <span class="n">mark_outlets</span> <span class="o">=</span> <span class="n">create_vtk_array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">surface</span><span class="o">.</span><span class="n">GetNumberOfCells</span><span class="p">()),</span> <span class="s2">&quot;outlets&quot;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">locator</span> <span class="o">=</span> <span class="n">get_locator_cell</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
    <span class="n">tmp_center</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>
        <span class="n">centers_filter</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCellCenters</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">centers_filter</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">centers_filter</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
        <span class="n">centers_filter</span><span class="o">.</span><span class="n">VertexCellsOn</span><span class="p">()</span>
        <span class="n">centers_filter</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">centers</span> <span class="o">=</span> <span class="n">centers_filter</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">centers</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()):</span>
            <span class="n">centers</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">tmp_center</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">cellId</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">mutable</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">subId</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">mutable</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">mutable</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">locator</span><span class="o">.</span><span class="n">FindClosestPoint</span><span class="p">(</span><span class="n">tmp_center</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cellId</span><span class="p">,</span> <span class="n">subId</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>
            <span class="n">mark_outlets</span><span class="o">.</span><span class="n">SetTuple</span><span class="p">(</span><span class="n">cellId</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">surface</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">mark_outlets</span><span class="p">)</span>

    <span class="c1"># Remove the outlets from the original surface</span>
    <span class="n">uncapped_surface</span> <span class="o">=</span> <span class="n">threshold</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="s2">&quot;outlets&quot;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;between&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Check if some cells where not marked</span>
    <span class="n">remove</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">while</span> <span class="n">remove</span><span class="p">:</span>
        <span class="n">locator</span> <span class="o">=</span> <span class="n">get_locator_cell</span><span class="p">(</span><span class="n">uncapped_surface</span><span class="p">)</span>
        <span class="n">mark_outlets</span> <span class="o">=</span> <span class="n">create_vtk_array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">uncapped_surface</span><span class="o">.</span><span class="n">GetNumberOfCells</span><span class="p">()),</span> <span class="s2">&quot;outlets&quot;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">remove</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">center</span> <span class="ow">in</span> <span class="n">centers_edge</span><span class="p">:</span>
            <span class="n">locator</span><span class="o">.</span><span class="n">FindClosestPoint</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cellId</span><span class="p">,</span> <span class="n">subId</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
                <span class="n">remove</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">mark_outlets</span><span class="o">.</span><span class="n">SetTuple</span><span class="p">(</span><span class="n">cellId</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">uncapped_surface</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">mark_outlets</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">remove</span><span class="p">:</span>
            <span class="n">uncapped_surface</span> <span class="o">=</span> <span class="n">threshold</span><span class="p">(</span><span class="n">uncapped_surface</span><span class="p">,</span> <span class="s2">&quot;outlets&quot;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                            <span class="n">upper</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;between&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">uncapped_surface</span>


<span class="k">def</span> <span class="nf">capp_surface</span><span class="p">(</span><span class="n">surface</span><span class="p">):</span>
    <span class="n">surfaceCapper</span> <span class="o">=</span> <span class="n">vtkvmtk</span><span class="o">.</span><span class="n">vtkvmtkCapPolyData</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">surfaceCapper</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">surfaceCapper</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
    <span class="n">surfaceCapper</span><span class="o">.</span><span class="n">SetDisplacement</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">surfaceCapper</span><span class="o">.</span><span class="n">SetInPlaneDisplacement</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">surfaceCapper</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">surfaceCapper</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">compute_distance_to_sphere</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">centerSphere</span><span class="p">,</span> <span class="n">radiusSphere</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                               <span class="n">distanceOffset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">distanceScale</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                               <span class="n">minDistance</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">maxDistance</span><span class="o">=</span><span class="mf">0.30</span><span class="p">,</span>
                               <span class="n">distanceToSpheresArrayName</span><span class="o">=</span><span class="s2">&quot;DistanceToSpheres&quot;</span><span class="p">):</span>

    <span class="c1"># Check if there allready exists a distance to spheres</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">surface</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span>
    <span class="n">number</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="n">get_number_of_arrays</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
    <span class="n">add</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">distanceToSpheresArrayName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span> <span class="n">add</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c1"># Get array</span>
    <span class="k">if</span> <span class="n">add</span><span class="p">:</span>
        <span class="n">dist_array</span> <span class="o">=</span> <span class="n">get_vtk_array</span><span class="p">(</span><span class="n">distanceToSpheresArrayName</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">surface</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">dist_array</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dist_array</span> <span class="o">=</span> <span class="n">surface</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="s2">&quot;DistanceToSpheres&quot;</span><span class="p">)</span>

    <span class="c1"># Compute distance</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">distanceToSphere</span> <span class="o">=</span> <span class="n">dist_array</span><span class="o">.</span><span class="n">GetComponent</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Get distance, but factor in size of sphere</span>
        <span class="n">newDist</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">centerSphere</span><span class="p">,</span> <span class="n">surface</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">-</span> <span class="n">radiusSphere</span>

        <span class="c1"># Set offset and scale distance</span>
        <span class="n">newDist</span> <span class="o">=</span> <span class="n">distanceOffset</span> <span class="o">+</span> <span class="n">newDist</span> <span class="o">*</span> <span class="n">distanceScale</span>

        <span class="c1"># Capp to min distance</span>
        <span class="k">if</span> <span class="n">newDist</span> <span class="o">&lt;</span> <span class="n">minDistance</span><span class="p">:</span>
            <span class="n">newDist</span> <span class="o">=</span> <span class="n">minDistance</span>

        <span class="c1"># Capp to max distance</span>
        <span class="k">if</span> <span class="n">newDist</span> <span class="o">&gt;</span> <span class="n">maxDistance</span><span class="p">:</span>
            <span class="n">newDist</span> <span class="o">=</span> <span class="n">maxDistance</span>

        <span class="c1"># Keep smallest distance</span>
        <span class="n">newDist</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">newDist</span><span class="p">,</span> <span class="n">distanceToSphere</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">add</span> <span class="k">else</span> <span class="n">newDist</span>

        <span class="n">dist_array</span><span class="o">.</span><span class="n">SetComponent</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">newDist</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">surface</span>


<span class="k">def</span> <span class="nf">is_surface_capped</span><span class="p">(</span><span class="n">surface</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">compute_centers</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">test_capped</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<div class="viewcode-block" id="get_connectivity"><a class="viewcode-back" href="../scripts.html#common.get_connectivity">[docs]</a><span class="k">def</span> <span class="nf">get_connectivity</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;All&quot;</span><span class="p">,</span> <span class="n">closestPoint</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute connectivity of the cells&quot;&quot;&quot;</span>
    <span class="n">connectivity</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataConnectivityFilter</span><span class="p">()</span>
    <span class="c1"># Backwards compatibility</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">connectivity</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">connectivity</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>

    <span class="c1"># Mark each region with &quot;RegionId&quot;</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;All&quot;</span><span class="p">:</span>
        <span class="n">connectivity</span><span class="o">.</span><span class="n">SetExtractionModeToAllRegions</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;Largest&quot;</span><span class="p">:</span>
        <span class="n">connectivity</span><span class="o">.</span><span class="n">SetExtractionModeToLargestRegion</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;Closest&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">closestPoint</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;ERROR: point not set for extracting closest region&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">connectivity</span><span class="o">.</span><span class="n">SetExtractionModeToClosestPointRegion</span><span class="p">()</span>
        <span class="n">connectivity</span><span class="o">.</span><span class="n">SetClosestPoint</span><span class="p">(</span><span class="n">closestPoint</span><span class="p">)</span>
    <span class="n">connectivity</span><span class="o">.</span><span class="n">ColorRegionsOn</span><span class="p">()</span>
    <span class="n">connectivity</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">connectivity</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">output</span></div>


<span class="k">def</span> <span class="nf">compute_circleness</span><span class="p">(</span><span class="n">surface</span><span class="p">):</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">getFeatureEdges</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>

    <span class="c1"># Get points</span>
    <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">edges</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()):</span>
        <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edges</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

    <span class="c1"># Compute center</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Compute ratio between max inscribed sphere, and min inscribed &quot;area&quot;</span>
    <span class="n">point_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">points</span><span class="o">-</span><span class="n">center</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">argsort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">point_radius</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">point_radius</span><span class="p">[</span><span class="n">argsort</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">/</span> <span class="n">point_radius</span><span class="p">[</span><span class="n">argsort</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
        <span class="n">radius_min</span> <span class="o">=</span> <span class="n">point_radius</span><span class="p">[</span><span class="n">argsort</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">radius_min</span> <span class="o">=</span> <span class="n">point_radius</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="n">min_area</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">radius_min</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">max_area</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">point_radius</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">max_area</span> <span class="o">/</span> <span class="n">min_area</span><span class="p">,</span> <span class="n">center</span>


<div class="viewcode-block" id="get_feature_edges"><a class="viewcode-back" href="../scripts.html#common.get_feature_edges">[docs]</a><span class="k">def</span> <span class="nf">get_feature_edges</span><span class="p">(</span><span class="n">polyData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extracts the edges of the cells that are open&quot;&quot;&quot;</span>
    <span class="n">featureEdges</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFeatureEdges</span><span class="p">()</span>
    <span class="n">featureEdges</span><span class="o">.</span><span class="n">FeatureEdgesOff</span><span class="p">()</span>
    <span class="n">featureEdges</span><span class="o">.</span><span class="n">BoundaryEdgesOn</span><span class="p">()</span>
    <span class="n">featureEdges</span><span class="o">.</span><span class="n">NonManifoldEdgesOff</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">featureEdges</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">featureEdges</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>
    <span class="n">featureEdges</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">featureEdges</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">compute_centers</span><span class="p">(</span><span class="n">polyData</span><span class="p">,</span> <span class="n">case_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">test_capped</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="c1"># Get cells which are open</span>
    <span class="n">cells</span> <span class="o">=</span> <span class="n">get_feature_edges</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>

    <span class="c1"># Check is the model is closed</span>
    <span class="k">if</span> <span class="n">test_capped</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cells</span><span class="o">.</span><span class="n">GetNumberOfCells</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">cells</span><span class="o">.</span><span class="n">GetNumberOfCells</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;WARNING: The model is capped, so it is uncapped, but the method is experimental.&quot;</span><span class="p">)</span>
        <span class="n">uncapped_surface</span> <span class="o">=</span> <span class="n">uncapp_surface</span><span class="p">(</span><span class="n">polyData</span><span class="p">)</span>
        <span class="n">compute_centers</span><span class="p">(</span><span class="n">uncapped_surface</span><span class="p">,</span> <span class="n">case_path</span><span class="p">,</span> <span class="n">test_capped</span><span class="p">)</span>

    <span class="c1"># Compute connectivity of the cells</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">getConnectivity</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span>

    <span class="c1"># Get connectivity array</span>
    <span class="n">region_array</span> <span class="o">=</span> <span class="n">get_array</span><span class="p">(</span><span class="s2">&quot;RegionId&quot;</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">test_capped</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">region_array</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">1</span>

    <span class="c1"># Get points</span>
    <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">get_point</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoint</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">region_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_point</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

    <span class="c1"># Get area and center</span>
    <span class="n">area</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">center</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">region_array</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Extract points for this opening</span>
        <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">region_array</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tmp_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Sort to be ordred clockwise</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">index</span><span class="p">][:,</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">x_end</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">x_end</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="n">x_end</span>
            <span class="n">tmp_points</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">x1</span>

        <span class="c1"># Insert points into VTK object</span>
        <span class="n">points_vtk</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPoints</span><span class="p">()</span>
        <span class="p">[</span><span class="n">points_vtk</span><span class="o">.</span><span class="n">InsertNextPoint</span><span class="p">(</span><span class="n">tmp_points</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>

        <span class="c1"># Make polygon</span>
        <span class="n">polygon</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolygon</span><span class="p">()</span>
        <span class="n">polygon</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">DeepCopy</span><span class="p">(</span><span class="n">points_vtk</span><span class="p">)</span>
        <span class="n">polygon</span><span class="o">.</span><span class="n">GetPointIds</span><span class="p">()</span><span class="o">.</span><span class="n">SetNumberOfIds</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">polygon</span><span class="o">.</span><span class="n">GetPointIds</span><span class="p">()</span><span class="o">.</span><span class="n">SetId</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>

        <span class="n">area</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">polygon</span><span class="o">.</span><span class="n">ComputeArea</span><span class="p">())</span>
        <span class="n">center</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">compute_bary_center</span><span class="p">(</span><span class="n">tmp_points</span><span class="p">)))</span>

    <span class="c1"># Store the center and area</span>
    <span class="n">inlet_ind</span> <span class="o">=</span> <span class="n">area</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">area</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">case_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;inlet&quot;</span><span class="p">:</span> <span class="n">center</span><span class="p">[</span><span class="n">inlet_ind</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s2">&quot;inlet_area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">[</span><span class="n">inlet_ind</span><span class="p">]}</span>
        <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">area</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">inlet_ind</span><span class="p">:</span> <span class="n">p</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="k">continue</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;outlet</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">p</span><span class="p">)]</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;outlet</span><span class="si">%s</span><span class="s2">_area&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">p</span><span class="p">)]</span> <span class="o">=</span> <span class="n">area</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">write_parameters</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">case_path</span><span class="p">)</span>

    <span class="n">inlet_center</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="n">inlet_ind</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">center</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">inlet_ind</span><span class="p">)</span>

    <span class="n">center_</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">center</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">inlet_center</span><span class="p">,</span> <span class="n">center_</span>


<span class="k">def</span> <span class="nf">compute_bary_center</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
    <span class="c1"># Get i+1</span>
    <span class="n">shifted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">shifted</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:]</span> <span class="o">=</span> <span class="n">points</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>
    <span class="n">shifted</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>

    <span class="c1"># Compute weights</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">points</span> <span class="o">-</span> <span class="n">shifted</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">weight_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>

    <span class="c1"># Compute center</span>
    <span class="n">center_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">points</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">shifted</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">weight</span><span class="p">)</span> <span class="o">/</span> <span class="n">weight_sum</span>
    <span class="n">center_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">points</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">shifted</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">weight</span><span class="p">)</span> <span class="o">/</span> <span class="n">weight_sum</span>
    <span class="n">center_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">points</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">shifted</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">weight</span><span class="p">)</span> <span class="o">/</span> <span class="n">weight_sum</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span><span class="p">,</span> <span class="n">center_z</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">get_vtk_array</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkDoubleArray</span><span class="p">()</span>
    <span class="n">array</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
    <span class="n">array</span><span class="o">.</span><span class="n">SetNumberOfTuples</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">comp</span><span class="p">):</span>
        <span class="n">array</span><span class="o">.</span><span class="n">FillComponent</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">array</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">array</span>


<span class="k">def</span> <span class="nf">get_locator_cell</span><span class="p">(</span><span class="n">surface</span><span class="p">):</span>
    <span class="n">locator</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCellLocator</span><span class="p">()</span>
    <span class="n">locator</span><span class="o">.</span><span class="n">SetDataSet</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
    <span class="n">locator</span><span class="o">.</span><span class="n">BuildLocator</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">locator</span>


<span class="k">def</span> <span class="nf">get_locator</span><span class="p">(</span><span class="n">centerline</span><span class="p">):</span>
    <span class="n">locator</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkStaticPointLocator</span><span class="p">()</span>
    <span class="n">locator</span><span class="o">.</span><span class="n">SetDataSet</span><span class="p">(</span><span class="n">centerline</span><span class="p">)</span>
    <span class="n">locator</span><span class="o">.</span><span class="n">BuildLocator</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">locator</span>


<span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">point1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">point2</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">remove_distant_points</span><span class="p">(</span><span class="n">voronoi</span><span class="p">,</span> <span class="n">centerline</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span>
    <span class="n">newVoronoi</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">()</span>
    <span class="n">cellArray</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCellArray</span><span class="p">()</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPoints</span><span class="p">()</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>

    <span class="n">locator</span> <span class="o">=</span> <span class="n">get_locator</span><span class="p">(</span><span class="n">centerline</span><span class="p">)</span>
    <span class="n">get_data</span> <span class="o">=</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">radiusArrayName</span><span class="p">)</span><span class="o">.</span><span class="n">GetTuple1</span>

    <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">N</span><span class="o">//</span><span class="mi">500</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">))[::</span><span class="n">m</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">get_data</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">limit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_data</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">limit_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">&gt;</span> <span class="n">x</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">limit_</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">ID</span> <span class="o">=</span> <span class="n">locator</span><span class="o">.</span><span class="n">FindClosestPoint</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
        <span class="n">cl_point</span> <span class="o">=</span> <span class="n">centerline</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">cl_point</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">limit</span><span class="p">(</span><span class="n">get_data</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">point</span><span class="p">,</span> <span class="n">dist</span><span class="p">):</span> 
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="n">points</span><span class="o">.</span><span class="n">InsertNextPoint</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
        <span class="n">cellArray</span><span class="o">.</span><span class="n">InsertNextCell</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cellArray</span><span class="o">.</span><span class="n">InsertCellPoint</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">count</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">radius</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">print</span><span class="p">((</span><span class="s2">&quot;Removed </span><span class="si">%s</span><span class="s2"> points from the voronoi diagram&quot;</span> <span class="o">%</span> <span class="n">count</span><span class="p">))</span>

    <span class="n">radiusArray</span> <span class="o">=</span> <span class="n">get_vtk_array</span><span class="p">(</span><span class="n">radiusArrayName</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">-</span><span class="n">count</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="n">count</span><span class="p">):</span>
        <span class="n">radiusArray</span><span class="o">.</span><span class="n">SetTuple</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">radius</span><span class="p">[</span><span class="n">i</span><span class="p">])])</span>


    <span class="n">newVoronoi</span><span class="o">.</span><span class="n">SetPoints</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">newVoronoi</span><span class="o">.</span><span class="n">SetVerts</span><span class="p">(</span><span class="n">cellArray</span><span class="p">)</span>
    <span class="n">newVoronoi</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">radiusArray</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">newVoronoi</span>


<span class="k">def</span> <span class="nf">vmtk_compute_centerline_sections</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">centerline</span><span class="p">):</span>
    <span class="n">centerlineSections</span> <span class="o">=</span> <span class="n">vtkvmtk</span><span class="o">.</span><span class="n">vtkvmtkPolyDataCenterlineSections</span><span class="p">()</span>
    <span class="n">centerlineSections</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
    <span class="n">centerlineSections</span><span class="o">.</span><span class="n">SetCenterlines</span><span class="p">(</span><span class="n">centerline</span><span class="p">)</span>
    <span class="n">centerlineSections</span><span class="o">.</span><span class="n">SetCenterlineSectionAreaArrayName</span><span class="p">(</span><span class="s1">&#39;CenterlineSectionArea&#39;</span><span class="p">)</span>
    <span class="n">centerlineSections</span><span class="o">.</span><span class="n">SetCenterlineSectionMinSizeArrayName</span><span class="p">(</span><span class="s1">&#39;CenterlineSectionMinSize&#39;</span><span class="p">)</span>
    <span class="n">centerlineSections</span><span class="o">.</span><span class="n">SetCenterlineSectionMaxSizeArrayName</span><span class="p">(</span><span class="s1">&#39;CenterlineSectionMaxSize&#39;</span><span class="p">)</span>
    <span class="n">centerlineSections</span><span class="o">.</span><span class="n">SetCenterlineSectionShapeArrayName</span><span class="p">(</span><span class="s1">&#39;CenterlineSectionShape&#39;</span><span class="p">)</span>
    <span class="n">centerlineSections</span><span class="o">.</span><span class="n">SetCenterlineSectionClosedArrayName</span><span class="p">(</span><span class="s1">&#39;CenterlineSectionClosed&#39;</span><span class="p">)</span>
    <span class="n">centerlineSections</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

    <span class="n">CenterlineSections</span> <span class="o">=</span> <span class="n">centerlineSections</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">centerlineSections</span><span class="o">.</span><span class="n">GetCenterlines</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">line</span><span class="p">,</span> <span class="n">CenterlineSections</span>

<span class="c1">#TODO: Merge / remove - use make_centerline instead</span>
<span class="k">def</span> <span class="nf">vmtk_compute_centerlines</span><span class="p">(</span><span class="n">inlet</span><span class="p">,</span> <span class="n">outlet</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">surface</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">smooth</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">num_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">smooth_factor</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                        <span class="n">endPoint</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;pointlist&quot;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">read_polydata</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

    <span class="n">centerlines</span> <span class="o">=</span> <span class="n">vmtkscripts</span><span class="o">.</span><span class="n">vmtkCenterlines</span><span class="p">()</span>
    <span class="n">centerlines</span><span class="o">.</span><span class="n">Surface</span> <span class="o">=</span> <span class="n">surface</span>
    <span class="n">centerlines</span><span class="o">.</span><span class="n">SeedSelectorName</span> <span class="o">=</span> <span class="s1">&#39;pointlist&#39;</span>
    <span class="n">centerlines</span><span class="o">.</span><span class="n">AppendEndPoints</span> <span class="o">=</span> <span class="n">endPoint</span>
    <span class="n">centerlines</span><span class="o">.</span><span class="n">Resampling</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">centerlines</span><span class="o">.</span><span class="n">ResamplingStepLength</span> <span class="o">=</span> <span class="n">resampling</span>
    <span class="n">centerlines</span><span class="o">.</span><span class="n">SourcePoints</span> <span class="o">=</span> <span class="n">inlet</span>
    <span class="n">centerlines</span><span class="o">.</span><span class="n">TargetPoints</span> <span class="o">=</span> <span class="n">outlet</span>
    <span class="n">centerlines</span><span class="o">.</span><span class="n">Execute</span><span class="p">()</span>
    <span class="n">centerlines</span> <span class="o">=</span> <span class="n">centerlines</span><span class="o">.</span><span class="n">Centerlines</span>

    <span class="k">if</span> <span class="n">smooth</span><span class="p">:</span>
        <span class="n">centerlineSmoothing</span> <span class="o">=</span> <span class="n">vmtkscripts</span><span class="o">.</span><span class="n">vmtkCenterlineSmoothing</span><span class="p">()</span>
        <span class="n">centerlineSmoothing</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Centerlines</span><span class="p">)</span>
        <span class="n">centerlineSmoothing</span><span class="o">.</span><span class="n">SetNumberOfSmoothingIterations</span><span class="p">(</span><span class="n">num_iter</span><span class="p">)</span>
        <span class="n">centerlineSmoothing</span><span class="o">.</span><span class="n">SetSmoothingFactor</span><span class="p">(</span><span class="n">smooth_factor</span><span class="p">)</span>
        <span class="n">centerlineSmoothing</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

        <span class="n">centerlines</span> <span class="o">=</span> <span class="n">centerlinesSmooth</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>

    <span class="c1"># Save the computed centerline.</span>
    <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">write_polydata</span><span class="p">(</span><span class="n">centerlines</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">centerlines</span>


<span class="k">def</span> <span class="nf">generate_mesh</span><span class="p">(</span><span class="n">surface</span><span class="p">):</span>
        <span class="c1"># Compute the mesh.</span>
        <span class="n">meshGenerator</span> <span class="o">=</span> <span class="n">vmtkscripts</span><span class="o">.</span><span class="n">vmtkMeshGenerator</span><span class="p">()</span>
        <span class="n">meshGenerator</span><span class="o">.</span><span class="n">Surface</span> <span class="o">=</span> <span class="n">surface</span>
        <span class="n">meshGenerator</span><span class="o">.</span><span class="n">ElementSizeMode</span> <span class="o">=</span> <span class="s2">&quot;edgelengtharray&quot;</span>
        <span class="n">meshGenerator</span><span class="o">.</span><span class="n">TargetEdgeLengthArrayName</span> <span class="o">=</span> <span class="s2">&quot;Size&quot;</span>
        <span class="n">meshGenerator</span><span class="o">.</span><span class="n">BoundaryLayer</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">meshGenerator</span><span class="o">.</span><span class="n">NumberOfSubLayers</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">meshGenerator</span><span class="o">.</span><span class="n">BoundaryLayerOnCaps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">meshGenerator</span><span class="o">.</span><span class="n">BoundaryLayerThicknessFactor</span> <span class="o">=</span> <span class="mf">0.85</span>
        <span class="n">meshGenerator</span><span class="o">.</span><span class="n">SubLayerRatio</span> <span class="o">=</span> <span class="mf">0.75</span>
        <span class="n">meshGenerator</span><span class="o">.</span><span class="n">Tetrahedralize</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">meshGenerator</span><span class="o">.</span><span class="n">VolumeElementScaleFactor</span> <span class="o">=</span> <span class="mf">0.8</span>
        <span class="n">meshGenerator</span><span class="o">.</span><span class="n">EndcapsEdgeLengthFactor</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># Mesh</span>
        <span class="n">meshGenerator</span><span class="o">.</span><span class="n">Execute</span><span class="p">()</span>

        <span class="c1"># Remeshed surface, store for later</span>
        <span class="n">remeshSurface</span> <span class="o">=</span> <span class="n">meshGenerator</span><span class="o">.</span><span class="n">RemeshedSurface</span>

        <span class="c1"># Full mesh</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">meshGenerator</span><span class="o">.</span><span class="n">Mesh</span>

        <span class="k">return</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">remeshSurface</span>

<span class="k">def</span> <span class="nf">create_vtk_array</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">vtkArray</span> <span class="o">=</span> <span class="n">get_vtk_array</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">vtkArray</span><span class="o">.</span><span class="n">SetTuple1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">vtkArray</span><span class="o">.</span><span class="n">SetTuple2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">vtkArray</span><span class="o">.</span><span class="n">SetTuple3</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">vtkArray</span><span class="o">.</span><span class="n">SetTuple9</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span>
                                  <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span>
                                  <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">8</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">vtkArray</span>


<span class="k">def</span> <span class="nf">gram_schmidt</span><span class="p">(</span><span class="n">V</span><span class="p">):</span>
    <span class="n">V</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">V</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">proj</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">u</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">u</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">u</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">V</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="n">U</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">proj</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="n">j</span><span class="p">],</span> <span class="n">V</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>

    <span class="c1"># normalize column</span>
    <span class="n">den</span><span class="o">=</span><span class="p">(</span><span class="n">U</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">U</span><span class="o">/</span><span class="n">den</span>
    <span class="k">return</span> <span class="n">E</span>


<span class="k">def</span> <span class="nf">get_parameters</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
    <span class="c1"># If info.txt file, return an empty dict</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;info.txt&quot;</span><span class="p">)):</span> <span class="k">return</span> <span class="p">{}</span>

    <span class="c1"># Get text</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;info.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Get values</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">par</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">split</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">split</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;: &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">write_parameters</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
    <span class="c1"># Get old parameters</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">get_parameters</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="c1"># Add new parameters (can overwrite old as well)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1"># Get new text</span>
    <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">())]</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="c1"># Write text</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;info.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<div class="viewcode-block" id="csv_to_txt"><a class="viewcode-back" href="../scripts.html#common.csv_to_txt">[docs]</a><span class="k">def</span> <span class="nf">csv_to_txt</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make it easier to access data with a normal txt file&quot;&quot;&quot;</span>
    <span class="n">csv</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;info.csv&quot;</span><span class="p">)</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;info.txt&quot;</span><span class="p">)</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)):</span>
        <span class="n">header</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;: &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">header</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">),</span>
                               <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)])</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="n">reader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">check_output</span><span class="p">(</span><span class="s2">&quot;mv &quot;</span> <span class="o">+</span> <span class="n">csv</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">txt</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">STDOUT</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">data_to_vtkPolyData</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">TNB</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">PT</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">()</span>
    <span class="n">cellArray</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCellArray</span><span class="p">()</span>
    <span class="n">cellArray</span><span class="o">.</span><span class="n">InsertNextCell</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">linePoints</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPoints</span><span class="p">()</span>

    <span class="n">info_array</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">radiusArray</span> <span class="o">=</span> <span class="n">get_vtk_array</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">info_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">radiusArray</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">TNB</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">radiusArray</span> <span class="o">=</span> <span class="n">get_vtk_array</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="mi">3</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">info_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">radiusArray</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">PT</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">TNB</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">radiusArray</span> <span class="o">=</span> <span class="n">get_vtk_array</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">start</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="n">PT</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">info_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">radiusArray</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">cellArray</span><span class="o">.</span><span class="n">InsertCellPoint</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">linePoints</span><span class="o">.</span><span class="n">InsertNextPoint</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,:</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">info_array</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">SetTuple1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">TNB</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">tnb_</span> <span class="o">=</span> <span class="n">TNB</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">i</span><span class="p">,:]</span>
                <span class="n">info_array</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">SetTuple3</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">tnb_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tnb_</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tnb_</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">PT</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">3</span> <span class="k">if</span> <span class="n">TNB</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">PT</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">pt_</span> <span class="o">=</span> <span class="n">PT</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="n">start</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">info_array</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">SetTuple3</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">pt_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt_</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt_</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">line</span><span class="o">.</span><span class="n">SetPoints</span><span class="p">(</span><span class="n">linePoints</span><span class="p">)</span>
    <span class="n">line</span><span class="o">.</span><span class="n">SetLines</span><span class="p">(</span><span class="n">cellArray</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">):</span>
        <span class="n">line</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">info_array</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">line</span>


<span class="k">def</span> <span class="nf">get_number_of_arrays</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArrayName</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">count</span><span class="p">,</span> <span class="n">names</span>


<span class="k">def</span> <span class="nf">extract_single_line</span><span class="p">(</span><span class="n">centerlines</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">startID</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">endID</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkGenericCell</span><span class="p">()</span>
    <span class="n">centerlines</span><span class="o">.</span><span class="n">GetCell</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span> <span class="k">if</span> <span class="n">endID</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">endID</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">line</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">()</span>
    <span class="n">cellArray</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCellArray</span><span class="p">()</span>
    <span class="n">cellArray</span><span class="o">.</span><span class="n">InsertNextCell</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="n">startID</span><span class="p">)</span>
    <span class="n">linePoints</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPoints</span><span class="p">()</span>

    <span class="n">arrays</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">N_</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="n">get_number_of_arrays</span><span class="p">(</span><span class="n">centerlines</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">centerlines</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">tmp_comp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">GetNumberOfComponents</span><span class="p">()</span>
        <span class="n">radiusArray</span> <span class="o">=</span> <span class="n">get_vtk_array</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tmp_comp</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="n">startID</span><span class="p">)</span>
        <span class="n">arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">radiusArray</span><span class="p">)</span>

    <span class="n">getArray</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_</span><span class="p">):</span>
        <span class="n">getArray</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">centerlines</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startID</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">cellArray</span><span class="o">.</span><span class="n">InsertCellPoint</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
        <span class="n">linePoints</span><span class="o">.</span><span class="n">InsertNextPoint</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_</span><span class="p">):</span>
            <span class="n">num</span> <span class="o">=</span> <span class="n">getArray</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">GetNumberOfComponents</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">getArray</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">GetTuple1</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">arrays</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">SetTuple1</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">getArray</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">GetTuple2</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">arrays</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">SetTuple2</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">getArray</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">GetTuple3</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">arrays</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">SetTuple3</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">getArray</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">GetTuple9</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">arrays</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">SetTuple9</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                                       <span class="n">tmp</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">line</span><span class="o">.</span><span class="n">SetPoints</span><span class="p">(</span><span class="n">linePoints</span><span class="p">)</span>
    <span class="n">line</span><span class="o">.</span><span class="n">SetLines</span><span class="p">(</span><span class="n">cellArray</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_</span><span class="p">):</span>
        <span class="n">line</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">arrays</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">line</span>


<div class="viewcode-block" id="move_past_sphere"><a class="viewcode-back" href="../scripts.html#common.move_past_sphere">[docs]</a><span class="k">def</span> <span class="nf">move_past_sphere</span><span class="p">(</span><span class="n">centerline</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">step</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Moves a point along the centerline until it as outside MIS&quot;&quot;&quot;</span>
    <span class="c1"># Create the minimal inscribed sphere</span>
    <span class="n">MISphere</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkSphere</span><span class="p">()</span>
    <span class="n">MISphere</span><span class="o">.</span><span class="n">SetCenter</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
    <span class="n">MISphere</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">X</span><span class="p">)</span>
    <span class="n">tempPoint</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>

    <span class="c1"># Go the length of one MISR backwards</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">MISphere</span><span class="o">.</span><span class="n">EvaluateFunction</span><span class="p">(</span><span class="n">centerline</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="o">&gt;=</span><span class="mf">0.0</span><span class="p">):</span>
            <span class="n">tempPoint</span> <span class="o">=</span> <span class="n">centerline</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">centerline</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">radiusArrayName</span><span class="p">)</span><span class="o">.</span><span class="n">GetTuple1</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tempPoint</span><span class="p">,</span> <span class="n">r</span></div>


<span class="k">def</span> <span class="nf">dist_sphere_curv</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">centerlines</span><span class="p">,</span> <span class="n">sac_center</span><span class="p">,</span> <span class="n">misr_max</span><span class="p">,</span> <span class="n">fileName</span><span class="p">):</span>
    <span class="c1"># Get longest centerline</span>
    <span class="n">length</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">centerlines</span><span class="o">.</span><span class="n">GetNumberOfLines</span><span class="p">()):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">extract_single_line</span><span class="p">(</span><span class="n">centerlines</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">length</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_curvilinear_coordinate</span><span class="p">(</span><span class="n">line</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ind_longest</span> <span class="o">=</span> <span class="n">length</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>

    <span class="c1"># Get all bifurcations along the longest centerline</span>
    <span class="n">bif</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bif_id</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">longest_line</span> <span class="o">=</span> <span class="n">extract_single_line</span><span class="p">(</span><span class="n">centerlines</span><span class="p">,</span> <span class="n">ind_longest</span><span class="p">)</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="n">get_tolerance</span><span class="p">(</span><span class="n">centerlines</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">centerlines</span><span class="o">.</span><span class="n">GetNumberOfLines</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">ind_longest</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">comp_line</span> <span class="o">=</span> <span class="n">extract_single_line</span><span class="p">(</span><span class="n">centerlines</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">comp_line</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()):</span>
            <span class="n">pnt1</span> <span class="o">=</span> <span class="n">longest_line</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">pnt2</span> <span class="o">=</span> <span class="n">comp_line</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">distance</span><span class="p">(</span><span class="n">pnt1</span><span class="p">,</span> <span class="n">pnt2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="n">bif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pnt1</span><span class="p">)</span>
                <span class="n">bif_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="k">break</span>

    <span class="c1"># Remove bifurcations detected twice</span>
    <span class="n">pop</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bif</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bif</span><span class="p">)):</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">bif</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bif</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">tol</span> <span class="o">*</span> <span class="mi">6</span><span class="p">:</span>
                <span class="n">pop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">pop</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">bif</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">bif_id</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="c1"># Set siphon to be the location of the first branch, assumes ICA as</span>
    <span class="c1"># inlet, and that the ophthalmic is segmented.</span>
    <span class="n">bif_id</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">siphon_point</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">bif_id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">distance_to_sphere</span> <span class="o">=</span> <span class="n">compute_distance_to_sphere</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">siphon_point</span><span class="p">)</span>

    <span class="c1"># Add the center of the sac</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sac_center</span><span class="p">)):</span>
        <span class="n">distance_to_sphere</span> <span class="o">=</span> <span class="n">compute_distance_to_sphere</span><span class="p">(</span><span class="n">distance_to_sphere</span><span class="p">,</span> <span class="n">sac_center</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                        <span class="n">distanceScale</span><span class="o">=</span><span class="mf">0.2</span> <span class="o">/</span> <span class="p">(</span><span class="n">misr_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.5</span><span class="p">))</span>

    <span class="c1"># Compute curvature</span>
    <span class="n">curvatureFilter</span> <span class="o">=</span> <span class="n">vmtkscripts</span><span class="o">.</span><span class="n">vmtkSurfaceCurvature</span><span class="p">()</span>
    <span class="n">curvatureFilter</span><span class="o">.</span><span class="n">AbsoluteCurvature</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">curvatureFilter</span><span class="o">.</span><span class="n">MedianFiltering</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">curvatureFilter</span><span class="o">.</span><span class="n">CurvatureType</span> <span class="o">=</span> <span class="s2">&quot;gaussian&quot;</span>
    <span class="n">curvatureFilter</span><span class="o">.</span><span class="n">Offset</span> <span class="o">=</span> <span class="mf">0.15</span>
    <span class="n">curvatureFilter</span><span class="o">.</span><span class="n">BoundedReciprocal</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">curvatureFilter</span><span class="o">.</span><span class="n">Surface</span> <span class="o">=</span> <span class="n">distance_to_sphere</span>
    <span class="n">curvatureFilter</span><span class="o">.</span><span class="n">Execute</span><span class="p">()</span>

    <span class="c1"># Multiple the surface</span>
    <span class="n">curvatureSurface</span> <span class="o">=</span> <span class="n">curvatureFilter</span><span class="o">.</span><span class="n">Surface</span>
    <span class="n">curvatureArray</span> <span class="o">=</span> <span class="n">get_array</span><span class="p">(</span><span class="s2">&quot;Curvature&quot;</span><span class="p">,</span> <span class="n">curvatureSurface</span><span class="p">)</span>
    <span class="n">distance_to_sphere_array</span> <span class="o">=</span> <span class="n">get_array</span><span class="p">(</span><span class="s2">&quot;DistanceToSpheres&quot;</span><span class="p">,</span> <span class="n">distance_to_sphere</span><span class="p">)</span>
    <span class="n">size_array</span> <span class="o">=</span> <span class="n">curvatureArray</span> <span class="o">*</span> <span class="n">distance_to_sphere_array</span>

    <span class="n">size_vtk_array</span> <span class="o">=</span> <span class="n">create_vtk_array</span><span class="p">(</span><span class="n">size_array</span><span class="p">,</span> <span class="s2">&quot;Size&quot;</span><span class="p">)</span>
    <span class="n">curvatureSurface</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">size_vtk_array</span><span class="p">)</span>

    <span class="n">write_polydata</span><span class="p">(</span><span class="n">curvatureSurface</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">distance_to_sphere</span>


<span class="k">def</span> <span class="nf">dist_sphere_diam</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">centerlines</span><span class="p">,</span> <span class="n">sac_center</span><span class="p">,</span> <span class="n">misr_max</span><span class="p">,</span> <span class="n">fileName</span><span class="p">):</span>
    <span class="c1"># Meshing method following Owais way.</span>
    <span class="c1"># --- Compute the distanceToCenterlines</span>
    <span class="n">distTocenterlines</span> <span class="o">=</span> <span class="n">vmtkscripts</span><span class="o">.</span><span class="n">vmtkDistanceToCenterlines</span><span class="p">()</span>
    <span class="n">distTocenterlines</span><span class="o">.</span><span class="n">Surface</span> <span class="o">=</span> <span class="n">surface</span>
    <span class="n">distTocenterlines</span><span class="o">.</span><span class="n">Centerlines</span> <span class="o">=</span> <span class="n">centerlines</span>
    <span class="n">distTocenterlines</span><span class="o">.</span><span class="n">Execute</span><span class="p">()</span>
    <span class="n">distance_to_sphere</span> <span class="o">=</span> <span class="n">distTocenterlines</span><span class="o">.</span><span class="n">Surface</span>

    <span class="c1"># Compute element size based on diameter</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">diameter_array</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">get_array</span><span class="p">(</span><span class="s2">&quot;DistanceToCenterlines&quot;</span><span class="p">,</span> <span class="n">distance_to_sphere</span><span class="p">)</span>
    <span class="n">element_size</span> <span class="o">=</span> <span class="mf">13.</span> <span class="o">/</span> <span class="mi">35</span> <span class="o">*</span> <span class="n">diameter_array</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">lower</span>
    <span class="n">element_size</span><span class="p">[</span><span class="n">element_size</span> <span class="o">&gt;</span> <span class="n">upper</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper</span>
    <span class="n">element_size</span><span class="p">[</span><span class="n">element_size</span> <span class="o">&lt;</span> <span class="n">lower</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower</span>
    <span class="n">elements_vtk</span> <span class="o">=</span> <span class="n">create_vtk_array</span><span class="p">(</span><span class="n">element_size</span><span class="p">,</span> <span class="s2">&quot;Num elements&quot;</span><span class="p">)</span>
    <span class="n">distance_to_sphere</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">elements_vtk</span><span class="p">)</span>
    <span class="n">element_size</span> <span class="o">=</span> <span class="n">diameter_array</span> <span class="o">/</span> <span class="n">element_size</span>
    <span class="c1">#element_size[element_size &lt; 0.12] = 0.12</span>

    <span class="c1">#distance_to_sphere = compute_distance_to_sphere(surface, siphon_point)</span>
    <span class="c1"># Reduce element size in aneurysm</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sac_center</span><span class="p">)):</span>
        <span class="n">distance_to_sphere</span> <span class="o">=</span> <span class="n">compute_distance_to_sphere</span><span class="p">(</span><span class="n">distance_to_sphere</span><span class="p">,</span>
                                                        <span class="n">sac_center</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                        <span class="c1">#maxDistance=0.3,</span>
                                                        <span class="n">distanceScale</span><span class="o">=</span><span class="mf">0.045</span><span class="p">)</span> <span class="c1"># / (misr_max[i] * 2.))</span>

    <span class="n">distance_to_spheres_array</span> <span class="o">=</span> <span class="n">get_array</span><span class="p">(</span><span class="s2">&quot;DistanceToSpheres&quot;</span><span class="p">,</span> <span class="n">distance_to_sphere</span><span class="p">)</span>
    <span class="n">element_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">element_size</span><span class="p">,</span> <span class="n">distance_to_spheres_array</span><span class="p">)</span>
    <span class="n">vtk_array</span> <span class="o">=</span> <span class="n">create_vtk_array</span><span class="p">(</span><span class="n">element_size</span><span class="p">,</span> <span class="s2">&quot;Size&quot;</span><span class="p">)</span>
    <span class="n">distance_to_sphere</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">vtk_array</span><span class="p">)</span>
    <span class="c1">#distance_to_sphere.GetPointData().RemoveArray(&quot;DistanceToCenterlines&quot;)</span>
    <span class="n">write_polydata</span><span class="p">(</span><span class="n">distance_to_sphere</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">distance_to_sphere</span>


<span class="k">def</span> <span class="nf">mesh_alternative</span><span class="p">(</span><span class="n">surface</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;--- Meshing failed.&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;--- Proceeding with surface smooting and meshing.&quot;</span><span class="p">)</span>
    <span class="n">surface</span> <span class="o">=</span> <span class="n">vmtkSmoother</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="s2">&quot;laplace&quot;</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

    <span class="n">subdiv</span> <span class="o">=</span> <span class="n">vmtkscripts</span><span class="o">.</span><span class="n">vmtkSurfaceSubdivision</span><span class="p">()</span>
    <span class="n">subdiv</span><span class="o">.</span><span class="n">Surface</span> <span class="o">=</span> <span class="n">surface</span>
    <span class="n">subdiv</span><span class="o">.</span><span class="n">Method</span> <span class="o">=</span> <span class="s2">&quot;butterfly&quot;</span>
    <span class="n">subdiv</span><span class="o">.</span><span class="n">Execute</span><span class="p">()</span>
    <span class="n">surface</span> <span class="o">=</span> <span class="n">subdiv</span><span class="o">.</span><span class="n">Surface</span>

    <span class="k">return</span> <span class="n">vmtkSmoother</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="s2">&quot;laplace&quot;</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">vmtk_surface_smoother</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">800</span><span class="p">):</span>
    <span class="n">smoother</span><span class="o">=</span> <span class="n">vmtkscripts</span><span class="o">.</span><span class="n">vmtkSurfaceSmoothing</span><span class="p">()</span>
    <span class="n">smoother</span><span class="o">.</span><span class="n">Surface</span> <span class="o">=</span> <span class="n">surface</span>
    <span class="n">smoother</span><span class="o">.</span><span class="n">NumberOfIterations</span> <span class="o">=</span> <span class="n">iterations</span>
    <span class="n">smoother</span><span class="o">.</span><span class="n">Method</span> <span class="o">=</span> <span class="n">method</span>
    <span class="n">smoother</span><span class="o">.</span><span class="n">Execute</span><span class="p">()</span>
    <span class="n">surface</span> <span class="o">=</span> <span class="n">smoother</span><span class="o">.</span><span class="n">Surface</span>

    <span class="k">return</span> <span class="n">surface</span>

    
<div class="viewcode-block" id="make_centerline"><a class="viewcode-back" href="../scripts.html#common.make_centerline">[docs]</a><span class="k">def</span> <span class="nf">make_centerline</span><span class="p">(</span><span class="n">ifile</span><span class="p">,</span> <span class="n">ofile</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">it</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">in_out</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">smooth</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">newpoints</span><span class="o">=</span> <span class="bp">None</span><span class="p">,</span> 
                   <span class="n">recompute</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">store_points</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">endpoints</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A general centerline command. If a centerline file with the same file</span>
<span class="sd">    name alread exists, then the file is just read. To overwrite this set</span>
<span class="sd">    recompute to True. If recomputed is to True then it uses the exsisting points</span>
<span class="sd">    from the old centerline file and no interaction with the interface is</span>
<span class="sd">    needed. Further on one can choose witch points you want to include by</span>
<span class="sd">    giving in_out. The first element in the list is the source point, and if -1</span>
<span class="sd">    is given, is chooses the old inlet, else it chooses outletX, where X is the</span>
<span class="sd">    outlet ID.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        ifile (vtkPolyData): Input surface model. </span>
<span class="sd">        ofile (str): Name of output file.</span>
<span class="sd">        length (float): Number in (0,1], the resampling step.</span>
<span class="sd">        it(int):  Number of iterations of smoothing</span>
<span class="sd">        factor (float): The smoothening factor</span>
<span class="sd">        smooth (bool): Used to turn on/off smoothening</span>
<span class="sd">        resampling (bool): Used to turn in/off resampling</span>
<span class="sd">        in_out (list): Outlet/inlet points that should be used when recompute</span>
<span class="sd">        newpoints (list): Outlet/inlet points that should be used when recompute</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check if ifile exsists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ifile</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;The input file: </span><span class="si">%s</span><span class="s2"> does not exsists!&quot;</span> <span class="o">%</span> <span class="n">ifile</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Check if it already exsists or if it is to be recomputed</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ofile</span><span class="p">)</span> <span class="ow">or</span> <span class="n">recompute</span><span class="p">:</span>
        <span class="c1"># If recomputed use the old source and target points</span>
        <span class="n">basedir</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ifile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">get_parameters</span><span class="p">(</span><span class="n">basedir</span><span class="p">)</span>

        <span class="n">vmtkcenterlines</span> <span class="o">=</span> <span class="n">vmtkscripts</span><span class="o">.</span><span class="n">vmtkCenterlines</span><span class="p">()</span>
        <span class="n">vmtkcenterlines</span><span class="o">.</span><span class="n">Surface</span> <span class="o">=</span> <span class="n">read_polydata</span><span class="p">(</span><span class="n">ifile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">newpoints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">inlet</span> <span class="o">=</span> <span class="n">newpoints</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">points_</span> <span class="o">=</span> <span class="n">newpoints</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">elif</span> <span class="s2">&quot;inlet&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">in_out</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">inlet</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;inlet&quot;</span><span class="p">]</span>
                <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="s2">&quot;outlet&quot;</span> <span class="ow">in</span> <span class="n">k</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">]</span>
                <span class="n">out</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="n">points_</span> <span class="o">=</span> <span class="p">[</span><span class="n">parameters</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">out</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inlet</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;inlet&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">in_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;outlet</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">in_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">points_</span> <span class="o">=</span> <span class="p">[</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;outlet</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">in_out</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>

        <span class="k">if</span> <span class="n">newpoints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="s2">&quot;inlet&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
            <span class="c1"># Extract outlet points</span>
            <span class="n">outlets</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points_</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p_</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
                    <span class="n">outlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_</span><span class="p">)</span>

            <span class="n">vmtkcenterlines</span><span class="o">.</span><span class="n">SeedSelectorName</span> <span class="o">=</span> <span class="s2">&quot;pointlist&quot;</span>
            <span class="n">vmtkcenterlines</span><span class="o">.</span><span class="n">SourcePoints</span> <span class="o">=</span> <span class="n">inlet</span>
            <span class="n">vmtkcenterlines</span><span class="o">.</span><span class="n">TargetPoints</span> <span class="o">=</span> <span class="n">outlets</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vmtkcenterlines</span><span class="o">.</span><span class="n">SeedSelectorName</span> <span class="o">=</span> <span class="s2">&quot;pickpoint&quot;</span>
        
        <span class="c1"># Add resampling</span>
        <span class="k">if</span> <span class="n">resampling</span><span class="p">:</span>
            <span class="n">vmtkcenterlines</span><span class="o">.</span><span class="n">Resampling</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">vmtkcenterlines</span><span class="o">.</span><span class="n">ResamplingStepLength</span> <span class="o">=</span> <span class="n">length</span>

        <span class="c1"># Exectue command and save centerline</span>
        <span class="n">vmtkcenterlines</span><span class="o">.</span><span class="n">AppendEndPoints</span> <span class="o">=</span> <span class="n">endpoints</span>
        <span class="n">vmtkcenterlines</span><span class="o">.</span><span class="n">Execute</span><span class="p">()</span>

        <span class="n">centerline</span> <span class="o">=</span> <span class="n">vmtkcenterlines</span><span class="o">.</span><span class="n">Centerlines</span>
        <span class="n">write_polydata</span><span class="p">(</span><span class="n">centerline</span><span class="p">,</span> <span class="n">ofile</span><span class="p">)</span>

        <span class="c1"># Add smoothing</span>
        <span class="k">if</span> <span class="n">smooth</span><span class="p">:</span>
            <span class="n">centerlineSmoothing</span> <span class="o">=</span> <span class="n">vmtkscripts</span><span class="o">.</span><span class="n">vmtkCenterlineSmoothing</span><span class="p">()</span>
            <span class="n">centerlineSmoothing</span><span class="o">.</span><span class="n">Centerlines</span> <span class="o">=</span> <span class="n">centerline</span>
            <span class="n">centerlineSmoothing</span><span class="o">.</span><span class="n">NumberOfSmoothingIterations</span> <span class="o">=</span> <span class="n">it</span>
            <span class="n">centerlineSmoothing</span><span class="o">.</span><span class="n">SmoothingFactor</span> <span class="o">=</span> <span class="n">factor</span>
            <span class="n">centerlineSmoothing</span><span class="o">.</span><span class="n">Execute</span><span class="p">()</span>
            <span class="n">centerline</span> <span class="o">=</span> <span class="n">centerlinesSmooth</span><span class="o">.</span><span class="n">Centerlines</span>

        <span class="c1"># If the points are not already storted, do it now</span>
        <span class="k">if</span> <span class="n">store_points</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">centerline</span><span class="o">.</span><span class="n">GetNumberOfLines</span><span class="p">()):</span>
                <span class="n">tmp_line</span> <span class="o">=</span> <span class="n">extract_single_line</span><span class="p">(</span><span class="n">centerline</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">tmp_N</span> <span class="o">=</span> <span class="n">tmp_line</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;outlet</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_line</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">tmp_N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;inlet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_line</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">write_parameters</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">basedir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">centerline</span> <span class="o">=</span> <span class="n">read_polydata</span><span class="p">(</span><span class="n">ofile</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">centerline</span></div>

<span class="c1"># Extract carotid siphon</span>
<span class="k">def</span> <span class="nf">extract_carotid_siphon</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">area_line</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">centerline_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;surface&quot;</span><span class="p">,</span> <span class="s2">&quot;model_usr_centerline.vtp&quot;</span><span class="p">)</span>
    <span class="n">centerline_bif_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;surface&quot;</span><span class="p">,</span> <span class="s2">&quot;model_usr_centerline_bif.vtp&quot;</span><span class="p">)</span>
    <span class="n">centerline_bif</span> <span class="o">=</span> <span class="n">read_polydata</span><span class="p">(</span><span class="n">centerline_bif_path</span><span class="p">)</span>
    <span class="n">centerline</span> <span class="o">=</span> <span class="n">read_polydata</span><span class="p">(</span><span class="n">centerline_path</span><span class="p">)</span>

    <span class="n">centerlineSpacing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">distance</span><span class="p">(</span><span class="n">centerline</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">centerline</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
    <span class="n">divergingTolerance</span> <span class="o">=</span> <span class="n">centerlineSpacing</span> <span class="o">/</span> <span class="n">divergingRatioToSpacingTolerance</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">centerline</span><span class="p">,</span> <span class="n">centerline_bif</span><span class="p">,</span> <span class="n">centerlineSpacing</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">extract_single_line</span><span class="p">(</span><span class="n">centerline</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">startID</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">endID</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;bif&quot;</span><span class="p">][</span><span class="s2">&quot;ID_div&quot;</span><span class="p">])</span>
    <span class="n">write_polydata</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;surface&quot;</span><span class="p">,</span> <span class="s2">&quot;carotid_siphon.vtp&quot;</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">line</span>


<span class="c1"># Resampling of centerline </span>
<span class="k">def</span> <span class="nf">vmtk_centerline_resampling</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">resampler</span> <span class="o">=</span> <span class="n">vmtkscripts</span><span class="o">.</span><span class="n">vmtkCenterlineResampling</span><span class="p">()</span>
    <span class="n">resampler</span><span class="o">.</span><span class="n">Centerlines</span> <span class="o">=</span> <span class="n">line</span>
    <span class="n">resampler</span><span class="o">.</span><span class="n">Length</span> <span class="o">=</span> <span class="n">length</span>
    <span class="n">resampler</span><span class="o">.</span><span class="n">Execute</span><span class="p">()</span>

    <span class="n">line</span> <span class="o">=</span> <span class="n">resampler</span><span class="o">.</span><span class="n">Centerlines</span>
    <span class="k">return</span> <span class="n">line</span> 

<span class="c1"># Check bool value for argparse</span>
<span class="k">def</span> <span class="nf">str2bool</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentTypeError</span><span class="p">(</span><span class="s1">&#39;Boolean value expected.&#39;</span><span class="p">)</span>

<span class="c1"># Compute geometric features of centerline</span>
<span class="k">def</span> <span class="nf">vmtk_centerline_geometry</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">smooth</span><span class="p">,</span> <span class="n">outputsmoothed</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">geometry</span> <span class="o">=</span> <span class="n">vmtkscripts</span><span class="o">.</span><span class="n">vmtkCenterlineGeometry</span><span class="p">()</span>
    <span class="n">geometry</span><span class="o">.</span><span class="n">Centerlines</span> <span class="o">=</span> <span class="n">line</span>
    <span class="k">if</span> <span class="n">smooth</span><span class="p">:</span>
        <span class="n">geometry</span><span class="o">.</span><span class="n">LineSmoothing</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">geometry</span><span class="o">.</span><span class="n">OutputSmoothedLines</span> <span class="o">=</span> <span class="n">outputsmoothed</span>
        <span class="n">geometry</span><span class="o">.</span><span class="n">SmoothingFactor</span> <span class="o">=</span> <span class="n">factor</span>
        <span class="n">geometry</span><span class="o">.</span><span class="n">NumberOfSmoothingIterations</span> <span class="o">=</span> <span class="n">iterations</span>
    <span class="n">geometry</span><span class="o">.</span><span class="n">CurvatureArrayName</span> <span class="o">=</span> <span class="s2">&quot;Curvature&quot;</span>
    <span class="n">geometry</span><span class="o">.</span><span class="n">TorsionArrayName</span> <span class="o">=</span> <span class="s2">&quot;Torsion&quot;</span>
    <span class="n">geometry</span><span class="o">.</span><span class="n">Execute</span><span class="p">()</span>

    <span class="n">line</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">Centerlines</span>
    <span class="k">return</span> <span class="n">line</span> 

<span class="k">def</span> <span class="nf">vmtk_centerline_attributes</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="n">vmtkscripts</span><span class="o">.</span><span class="n">vmtkCenterlineAttributes</span><span class="p">()</span>
    <span class="n">attributes</span><span class="o">.</span><span class="n">Centerlines</span> <span class="o">=</span> <span class="n">line</span>
    <span class="n">attributes</span><span class="o">.</span><span class="n">NormalsArrayName</span> <span class="o">=</span> <span class="n">parallelTransportNormalsArrayName</span> 
    <span class="n">attributes</span><span class="o">.</span><span class="n">AbscissaArrayName</span> <span class="o">=</span> <span class="n">abscissasArrayName</span> 
    <span class="n">attributes</span><span class="o">.</span><span class="n">Execute</span><span class="p">()</span>
    
    <span class="n">line</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">Centerlines</span>
    <span class="k">return</span> <span class="n">line</span>


<div class="viewcode-block" id="spline_matlab"><a class="viewcode-back" href="../scripts.html#common.spline_matlab">[docs]</a><span class="k">def</span> <span class="nf">spline_matlab</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">init_knots</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform Knot-free regresion spline on input centerline</span>
<span class="sd">    extracted from input filename</span>
<span class="sd">    Includes loading of matlab engine.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Computing knot free regression spline&quot;</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="n">init_knots</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">init_knots</span><span class="p">)</span>
    <span class="n">mlab</span> <span class="o">=</span> <span class="n">matlab</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">start_matlab</span><span class="p">()</span>
    <span class="n">curv_m</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">CenterlineCharacterization</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">init_knots</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">nargout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">curv_m</span><span class="p">)</span>
    <span class="n">curv_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">curv_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">curv_m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">curv_p</span></div>

<div class="viewcode-block" id="write_centerline"><a class="viewcode-back" href="../scripts.html#common.write_centerline">[docs]</a><span class="k">def</span> <span class="nf">write_centerline</span><span class="p">(</span><span class="n">centerline</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write centerline points to text file</span>
<span class="sd">    used for computation of curvature in</span>
<span class="sd">    matlab</span>

<span class="sd">    Args:</span>
<span class="sd">        centerline: Centerline data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Path to centerline points </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">P</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">centerline</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()):</span>
        <span class="n">P</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">centerline</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>

    <span class="n">clfile</span> <span class="o">=</span> <span class="s2">&quot;centerline.txt&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">clfile</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">P</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">clfile</span></div>


<span class="k">def</span> <span class="nf">discrete_geometry</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">neigh</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">len_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span> 

    <span class="c1"># Compute cumulative chord length</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">))))</span>
        <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">norms</span> <span class="o">=</span> <span class="p">[</span><span class="n">la</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">)]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">norms</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">norms</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">/</span> <span class="n">s</span>

    <span class="c1"># Radius of sliding neighbourhood</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">neigh</span>

    <span class="n">dxdt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">dydt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">dzdt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
 

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">t_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
        <span class="n">dxdt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span> <span class="o">/</span> <span class="n">t_sum</span>
        <span class="n">dydt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span> <span class="o">/</span> <span class="n">t_sum</span>
        <span class="n">dzdt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span> <span class="o">/</span> <span class="n">t_sum</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">N</span><span class="o">-</span><span class="n">m</span><span class="p">):</span>
        <span class="n">t_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
        <span class="n">dxdt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span> <span class="o">/</span> <span class="n">t_sum</span>
        <span class="n">dydt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span> <span class="o">/</span> <span class="n">t_sum</span>
        <span class="n">dzdt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span> <span class="o">/</span> <span class="n">t_sum</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">t_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">N</span><span class="p">)])</span>
        <span class="n">dxdt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)])</span> <span class="o">/</span> <span class="n">t_sum</span>
        <span class="n">dydt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)])</span> <span class="o">/</span> <span class="n">t_sum</span>
        <span class="n">dzdt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)])</span> <span class="o">/</span> <span class="n">t_sum</span>

    <span class="n">dgammadt</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dgammadt_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">dgammadt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dxdt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dydt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dzdt</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>
        <span class="n">dgammadt_norm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dgammadt</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    
    <span class="n">tg</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">tg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dgammadt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">dgammadt_norm</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">t1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">t3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">t1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tg</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">t2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tg</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">t3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tg</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
    
    <span class="n">dt1dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">dt2dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">dt3dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">t_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
        <span class="n">dt1dt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">t1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span> <span class="o">/</span> <span class="n">t_sum</span>
        <span class="n">dt2dt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">t2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">t2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span> <span class="o">/</span> <span class="n">t_sum</span>
        <span class="n">dt3dt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">t3</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">t3</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span> <span class="o">/</span> <span class="n">t_sum</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">N</span><span class="o">-</span><span class="n">m</span><span class="p">):</span>
        <span class="n">t_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
        <span class="n">dt1dt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">t1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span> <span class="o">/</span> <span class="n">t_sum</span>
        <span class="n">dt2dt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">t2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">t2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span> <span class="o">/</span> <span class="n">t_sum</span>
        <span class="n">dt3dt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">t3</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">t3</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span> <span class="o">/</span> <span class="n">t_sum</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">t_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">N</span><span class="p">)])</span>
        <span class="n">dt1dt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">t1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)])</span> <span class="o">/</span> <span class="n">t_sum</span>
        <span class="n">dt2dt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">t2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">t2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)])</span> <span class="o">/</span> <span class="n">t_sum</span>
        <span class="n">dt3dt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">t3</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">t3</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)])</span> <span class="o">/</span> <span class="n">t_sum</span>

    <span class="n">dtgdt</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dtgdt_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">dtgdt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dt1dt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dt2dt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dt3dt</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>
        <span class="n">dtgdt_norm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dtgdt</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">curv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">curv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtgdt_norm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">dgammadt_norm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">curv</span> <span class="o">=</span> <span class="n">resample</span><span class="p">(</span><span class="n">curv</span><span class="p">,</span> <span class="n">len_line</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">line</span><span class="p">,</span> <span class="n">curv</span>

<div class="viewcode-block" id="get_k1k2_basis"><a class="viewcode-back" href="../scripts.html#common.get_k1k2_basis">[docs]</a><span class="k">def</span> <span class="nf">get_k1k2_basis</span><span class="p">(</span><span class="n">curvature</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Create a k1-k2 basis used to determine </span>
<span class="sd">    the location of each bend of the carotid</span>
<span class="sd">    siphon. </span>

<span class="sd">    Args:</span>
<span class="sd">        curvature (floats): Curvature array.</span>
<span class="sd">        line (vtk): Centerline points. </span>

<span class="sd">    Returns: </span>
<span class="sd">        line (vtk): Centerline points including k1-k2 basis.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># The ParallelTransportNormals and the FrenetTangent is not orthonormal</span>
    <span class="c1"># (but close) from vmtk. Using the GramSchmidt proses gives E2 and fixes</span>
    <span class="c1"># the non-orthogonality</span>
    <span class="n">E1</span> <span class="o">=</span> <span class="n">get_array</span><span class="p">(</span><span class="s2">&quot;ParallelTransportNormals&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">get_array</span><span class="p">(</span><span class="s2">&quot;FrenetTangent&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">E2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">E1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">E1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">V</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
        <span class="n">V</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">E1</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">gram_schmidt</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>

        <span class="n">E1</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">V</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">E2</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">V</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Compute k_1, k_2 furfilling T&#39; = curv(s)*N(s) = k_1(s)*E_1(s) + k_2(s)*E_2(s).</span>
    <span class="c1"># This is simply a change of basis for the curvature vector N. The room</span>
    <span class="c1"># of k_1 and k_2 can be used to express both the curvature and the</span>
    <span class="c1"># torsion.</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">get_array</span><span class="p">(</span><span class="s2">&quot;FrenetNormal&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">k2</span> <span class="o">=</span> <span class="p">(</span><span class="n">curvature</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="p">(</span><span class="n">E1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">N</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">E1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> \
                        <span class="p">(</span><span class="n">E2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">E1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">E2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">E1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">k1</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">curvature</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">N</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">k2</span><span class="o">*</span><span class="n">E2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">E1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">k1</span><span class="p">,</span> <span class="s2">&quot;k1&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">k2</span><span class="p">,</span> <span class="s2">&quot;k2&quot;</span><span class="p">)]:</span>
        <span class="n">k_array</span> <span class="o">=</span> <span class="n">create_vtk_array</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">line</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">k_array</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">line</span></div>

<div class="viewcode-block" id="spline_centerline"><a class="viewcode-back" href="../scripts.html#common.spline_centerline">[docs]</a><span class="k">def</span> <span class="nf">spline_centerline</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">get_curv</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">isline</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">nknots</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">get_stats</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given the knots and coefficients of a B-spline representation, </span>
<span class="sd">    evaluate the value of the smoothing polynomial and its derivatives. </span>
<span class="sd">    This is a wrapper around the FORTRAN routines splev and splder of FITPACK.</span>

<span class="sd">    Args: </span>
<span class="sd">        line (vtkPolyData): Centerline points.</span>
<span class="sd">        get_curv (bool): Computes curvature profile if True. </span>
<span class="sd">        isline (bool): Determines if centerline object is a line or points.</span>
<span class="sd">        nknots (int): Number of knots. </span>
<span class="sd">        get_stats (bool): Determines if curve attribuites are computed or not.</span>

<span class="sd">    Returns: </span>
<span class="sd">        line (vtkPolyData): Splined centerline data.</span>
<span class="sd">    Returns:</span>
<span class="sd">        curv (ndarray): Curvature profile. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isline</span><span class="p">:</span>
        <span class="c1"># Create edges between new_centerline points</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPoints</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="n">line</span><span class="o">.</span><span class="n">GetNumberOfCells</span><span class="p">())):</span>
            <span class="n">pts</span><span class="o">.</span><span class="n">InsertNextPoint</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCellArray</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="n">line</span><span class="o">.</span><span class="n">GetNumberOfCells</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">newline</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkLine</span><span class="p">()</span>
            <span class="n">newline</span><span class="o">.</span><span class="n">GetPointIds</span><span class="p">()</span><span class="o">.</span><span class="n">SetId</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">newline</span><span class="o">.</span><span class="n">GetPointIds</span><span class="p">()</span><span class="o">.</span><span class="n">SetId</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">InsertNextCell</span><span class="p">(</span><span class="n">newline</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">()</span>
        <span class="n">line</span><span class="o">.</span><span class="n">SetPoints</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">SetLines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="c1"># Collect data from centerline</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">line</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">(),</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">MISR</span> <span class="o">=</span> <span class="n">get_array</span><span class="p">(</span><span class="n">radiusArrayName</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>

    <span class="n">curv_coor</span> <span class="o">=</span> <span class="n">get_curvilinear_coordinate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">curv_coor</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">curv_coor</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">nknots</span><span class="o">+</span><span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">fx</span> <span class="o">=</span> <span class="n">splrep</span><span class="p">(</span><span class="n">curv_coor</span><span class="p">,</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
    <span class="n">fy</span> <span class="o">=</span> <span class="n">splrep</span><span class="p">(</span><span class="n">curv_coor</span><span class="p">,</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
    <span class="n">fz</span> <span class="o">=</span> <span class="n">splrep</span><span class="p">(</span><span class="n">curv_coor</span><span class="p">,</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>

    <span class="n">fx_</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">curv_coor</span><span class="p">,</span> <span class="n">fx</span><span class="p">)</span>
    <span class="n">fy_</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">curv_coor</span><span class="p">,</span> <span class="n">fy</span><span class="p">)</span>
    <span class="n">fz_</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">curv_coor</span><span class="p">,</span> <span class="n">fz</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">curv_coor</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fx_</span>
    <span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fy_</span>
    <span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">fz_</span>
    <span class="n">data</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MISR</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="n">radiusArrayName</span><span class="p">]</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">data_to_vtkPolyData</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
   
    <span class="c1"># Let vmtk compute curve attributes</span>
    <span class="k">if</span> <span class="n">get_stats</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">vmtk_centerline_geometry</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">get_curv</span><span class="p">:</span>
        <span class="c1"># Analytical curvature</span>
        <span class="n">dlsfx</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">curv_coor</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dlsfy</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">curv_coor</span><span class="p">,</span> <span class="n">fy</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dlsfz</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">curv_coor</span><span class="p">,</span> <span class="n">fz</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">ddlsfx</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">curv_coor</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ddlsfy</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">curv_coor</span><span class="p">,</span> <span class="n">fy</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ddlsfz</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">curv_coor</span><span class="p">,</span> <span class="n">fz</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">C1xC2_1</span> <span class="o">=</span> <span class="n">ddlsfz</span> <span class="o">*</span> <span class="n">dlsfy</span> <span class="o">-</span> <span class="n">ddlsfy</span> <span class="o">*</span> <span class="n">dlsfz</span>
        <span class="n">C1xC2_2</span> <span class="o">=</span> <span class="n">ddlsfx</span> <span class="o">*</span> <span class="n">dlsfz</span> <span class="o">-</span> <span class="n">ddlsfz</span> <span class="o">*</span> <span class="n">dlsfx</span>
        <span class="n">C1xC2_3</span> <span class="o">=</span> <span class="n">ddlsfy</span> <span class="o">*</span> <span class="n">dlsfx</span> <span class="o">-</span> <span class="n">ddlsfx</span> <span class="o">*</span> <span class="n">dlsfy</span>

        <span class="n">curvature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">C1xC2_1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">C1xC2_2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">C1xC2_3</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> \
                            <span class="p">(</span><span class="n">dlsfx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dlsfy</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dlsfz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">1.5</span>

        <span class="k">return</span> <span class="n">line</span><span class="p">,</span> <span class="n">curvature</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">line</span></div>

</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Aslak Bergersen &amp; Henrik Kjeldsberg.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>