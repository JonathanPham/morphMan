

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>move_branches &mdash; VMTK TOOLS 0.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="VMTK TOOLS 0.1 documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../vmtktools_docs.html" class="icon icon-home"> VMTK TOOLS
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Using VMTK Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scripts.html">Documentation for the Python Scripts</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../vmtktools_docs.html">VMTK TOOLS</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../vmtktools_docs.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Module code</a> &raquo;</li>
      
    <li>move_branches</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for move_branches</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">common</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">ArgumentParser</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">listdir</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">STDOUT</span><span class="p">,</span> <span class="n">check_output</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">embed</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="c1"># Local import</span>
<span class="kn">from</span> <span class="nn">patchandinterpolatecenterlines</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">clipvoronoidiagram</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">paralleltransportvoronoidiagram</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">ToolRepairSTL</span>

<div class="viewcode-block" id="read_command_line"><a class="viewcode-back" href="../scripts.html#move_branches.read_command_line">[docs]</a><span class="k">def</span> <span class="nf">read_command_line</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read arguments from commandline</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Change to --feature --no-feature for bool agruments</span>
    <span class="c1"># Ex. </span>
    <span class="c1"># feature_parser = parser.add_mutually_exclusive_group(required=False)</span>
    <span class="c1"># feature_parser.add_argument(&#39;--feature&#39;, dest=&#39;feature&#39;, action=&#39;store_true&#39;)</span>
    <span class="c1"># feature_parser.add_argument(&#39;--no-feature&#39;, dest=&#39;feature&#39;, action=&#39;store_false&#39;)</span>
    <span class="c1"># parser.set_defaults(feature=True)</span>

    <span class="c1"># Also add choise when that is approporiate</span>

    <span class="c1"># Could also make bool be int and add choise 0, 1 to be true false...</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">()</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--dir_path&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to the folder with all the cases&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--case&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose case&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--s&#39;</span><span class="p">,</span> <span class="s1">&#39;--smooth&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If the original voronoi diagram (surface) should be&quot;</span> <span class="o">+</span> \
                        <span class="s2">&quot;smoothed before it is manipulated&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;smooth&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--a&#39;</span><span class="p">,</span> <span class="s1">&#39;--angle&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Each daughter branch is rotated an angle a in the&quot;</span> <span class="o">+</span> \
                        <span class="s2">&quot; bifurcation plane. a should be expressed in radians as&quot;</span> <span class="o">+</span> \
                        <span class="s2">&quot; any math expression from the&quot;</span> <span class="o">+</span> \
                        <span class="s2">&quot; math module in python&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;rotation_angle&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--smooth_factor&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If smooth option is true then each voronoi point&quot;</span> <span class="o">+</span> \
                         <span class="s2">&quot; that has a radius less then MISR*(1-smooth_factor) at&quot;</span> <span class="o">+</span> \
                         <span class="s2">&quot; the closest centerline point is removes&quot;</span><span class="p">,</span>
                         <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;smoothening_factor&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--leave1&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Leave one branch untuched&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--leave2&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Leave one branch untuched&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--bif&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;interpolate bif as well&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--lower&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Make a fourth line to interpolate along that&quot;</span> <span class="o">+</span> \
                             <span class="s2">&quot; is lower than the other bif line.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--cylinder_factor&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">7.0</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Factor for choosing the smaller cylinder&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--version&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Type of&quot;</span> <span class="o">+</span> \
                        <span class="s2">&quot;interpolation&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--aneurysm&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Determines if there is an aneurysm or not&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--anu_num&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If multiple aneurysms, choise one&quot;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--step&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Resampling step used to resample centerlines&quot;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">ang_</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">a</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">args</span><span class="o">.</span><span class="n">a</span>

    <span class="k">return</span> <span class="n">args</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">ang_</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">smooth_factor</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">leave1</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">leave2</span><span class="p">,</span> \
           <span class="n">args</span><span class="o">.</span><span class="n">bif</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">case</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> \
           <span class="n">args</span><span class="o">.</span><span class="n">cylinder_factor</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">aneurysm</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">anu_num</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">step</span></div>



<div class="viewcode-block" id="get_points"><a class="viewcode-back" href="../scripts.html#move_branches.get_points">[docs]</a><span class="k">def</span> <span class="nf">get_points</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">rotated</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">bif</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds spesific points around the bifurcation, based on the</span>
<span class="sd">    key argument. Points can before or after rotation. </span>

<span class="sd">    Args:</span>
<span class="sd">        data (dict): Contains information about points and IDs of branches and bifurcation.</span>
<span class="sd">        key (str): Type of points to extract.</span>
<span class="sd">        R (ndarray): Matrix containing unit vectors in the rotated coordinate system.</span>
<span class="sd">        m (dict): Cointains rotation matrices for each daughter branch.</span>
<span class="sd">        rotated (bool): Gets rotated points if True.</span>
<span class="sd">        bif (true): Gets only bifurcation points if True.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        points (vtkPoints): Points as VTK objects.</span>
<span class="sd">    Returns:</span>
<span class="sd">        div_points_bif (ndarray): Points as numpy objects. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">div_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;bif&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">key</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">key</span><span class="p">]])</span>

    <span class="c1"># Origo of the bifurcation</span>
    <span class="n">O_key</span> <span class="o">=</span> <span class="s2">&quot;div_point&quot;</span>
    <span class="n">O</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;bif&quot;</span><span class="p">][</span><span class="n">O_key</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">O_key</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">O_key</span><span class="p">]])</span>
    <span class="n">O</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">O</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mf">3.</span>

    <span class="k">if</span> <span class="n">rotated</span><span class="p">:</span>
        <span class="n">R_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">div_points</span><span class="p">)):</span>
            <span class="n">m_</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">div_points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">div_points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">O</span><span class="p">,</span> <span class="n">R</span><span class="p">),</span> <span class="n">m_</span><span class="p">),</span> <span class="n">R_inv</span><span class="p">)</span> <span class="o">+</span> <span class="n">O</span>

    <span class="c1"># Insert landmarking points into VTK objects</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPoints</span><span class="p">()</span>
    <span class="n">div_points_bif</span> <span class="o">=</span> <span class="n">div_points</span><span class="p">[</span><span class="n">bif</span><span class="p">:]</span>
    <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">div_points_bif</span><span class="p">:</span>
        <span class="n">points</span><span class="o">.</span><span class="n">InsertNextPoint</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">div_points_bif</span></div>


<div class="viewcode-block" id="rotate_voronoi"><a class="viewcode-back" href="../scripts.html#move_branches.rotate_voronoi">[docs]</a><span class="k">def</span> <span class="nf">rotate_voronoi</span><span class="p">(</span><span class="n">clipped_voronoi</span><span class="p">,</span> <span class="n">patch_cl</span><span class="p">,</span> <span class="n">div_points</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform rotation of the voronoi diagram representing the </span>
<span class="sd">    daughter branches. Rotate along the bifurcation plane</span>
<span class="sd">    spanned by two vectors, preserving the angle with</span>
<span class="sd">    the rest of the vasculature. Rotation is performed</span>
<span class="sd">    using a standard rotational matrix m. </span>

<span class="sd">    Args:</span>
<span class="sd">        clipped_voronoi (vtkPolyData): Clipped voronoi diagram.</span>
<span class="sd">        patch_cl (vtkPolyData): Clipped centerline.</span>
<span class="sd">        div_points (ndarray): Contains bifurcation landmarking points. </span>
<span class="sd">        R (ndarray): Matrix containing unit vectors in the rotated coordinate system.</span>
<span class="sd">        m (dict): Cointains rotation matrices for each daughter branch.</span>
<span class="sd">    Returns:</span>
<span class="sd">        maskedVoronoi (vtkPolyData): Rotated voronoi diagram. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">numberOfPoints</span> <span class="o">=</span> <span class="n">clipped_voronoi</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkMath</span><span class="o">.</span><span class="n">Distance2BetweenPoints</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">R_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>

    <span class="n">locator</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cellLine</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">not_rotate</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">patch_cl</span><span class="o">.</span><span class="n">GetNumberOfCells</span><span class="p">()):</span>
        <span class="n">cellLine</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extract_single_line</span><span class="p">(</span><span class="n">patch_cl</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
        <span class="n">tmp_locator</span> <span class="o">=</span> <span class="n">get_locator</span><span class="p">(</span><span class="n">cellLine</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">locator</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_locator</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">patch_cl</span><span class="o">.</span><span class="n">GetNumberOfCells</span><span class="p">()):</span>
        <span class="n">pnt</span> <span class="o">=</span> <span class="n">cellLine</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">cellLine</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">locator</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">FindClosestPoint</span><span class="p">(</span><span class="n">pnt</span><span class="p">))</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">distance</span><span class="p">(</span><span class="n">pnt</span><span class="p">,</span> <span class="n">new</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">divergingRatioToSpacingTolerance</span>
        <span class="k">if</span> <span class="n">dist</span><span class="p">:</span>
            <span class="n">not_rotate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_rotate</span><span class="p">(</span><span class="n">point</span><span class="p">):</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">locator</span><span class="p">)):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">locator</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">FindClosestPoint</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">cellLine</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">distance</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">point</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">dist</span><span class="p">))</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">not_rotate</span><span class="p">:</span>
            <span class="n">pnt</span> <span class="o">=</span> <span class="n">cellLine</span><span class="p">[</span><span class="n">dist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">dist</span><span class="p">))]</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">distance</span><span class="p">(</span><span class="n">pnt</span><span class="p">,</span> <span class="n">div_points</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">&gt;</span>  \
                    <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">distance</span><span class="p">(</span><span class="n">pnt</span><span class="p">,</span> <span class="n">div_points</span><span class="p">[</span><span class="mi">2</span><span class="p">])):</span>
                <span class="n">m_</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">div</span> <span class="o">=</span> <span class="n">div_points</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">m_</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">div</span> <span class="o">=</span> <span class="n">div_points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">m_</span><span class="p">,</span> <span class="n">div</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">I</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    
    <span class="n">maskedVoronoi</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">()</span>
    <span class="n">maskedPoints</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPoints</span><span class="p">()</span>
    <span class="n">cellArray</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCellArray</span><span class="p">()</span>
    <span class="n">radiusArray</span> <span class="o">=</span> <span class="n">get_vtk_array</span><span class="p">(</span><span class="n">radiusArrayName</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numberOfPoints</span><span class="p">)</span> 

    <span class="c1"># Iterate through voronoi diagram</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numberOfPoints</span><span class="p">):</span>
        <span class="n">point</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
        <span class="n">clipped_voronoi</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">point</span><span class="p">)</span>

        <span class="n">pointRadius</span> <span class="o">=</span> <span class="n">clipped_voronoi</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">radiusArrayName</span><span class="p">)</span><span class="o">.</span><span class="n">GetTuple1</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">M</span><span class="p">,</span> <span class="n">O</span> <span class="o">=</span> <span class="n">check_rotate</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="o">-</span> <span class="n">O</span><span class="p">,</span> <span class="n">R</span><span class="p">),</span> <span class="n">M</span><span class="p">),</span> <span class="n">R_inv</span><span class="p">)</span> <span class="o">+</span> <span class="n">O</span>
        <span class="n">maskedPoints</span><span class="o">.</span><span class="n">InsertNextPoint</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="n">radiusArray</span><span class="o">.</span><span class="n">SetTuple1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">pointRadius</span><span class="p">)</span>
        <span class="n">cellArray</span><span class="o">.</span><span class="n">InsertNextCell</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cellArray</span><span class="o">.</span><span class="n">InsertCellPoint</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="n">maskedVoronoi</span><span class="o">.</span><span class="n">SetPoints</span><span class="p">(</span><span class="n">maskedPoints</span><span class="p">)</span>
    <span class="n">maskedVoronoi</span><span class="o">.</span><span class="n">SetVerts</span><span class="p">(</span><span class="n">cellArray</span><span class="p">)</span>
    <span class="n">maskedVoronoi</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">radiusArray</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">maskedVoronoi</span></div>


<div class="viewcode-block" id="rotate_cl"><a class="viewcode-back" href="../scripts.html#move_branches.rotate_cl">[docs]</a><span class="k">def</span> <span class="nf">rotate_cl</span><span class="p">(</span><span class="n">patch_cl</span><span class="p">,</span> <span class="n">div_points</span><span class="p">,</span> <span class="n">rotation_matrix</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform rotation of the centerline representing the </span>
<span class="sd">    daughter branches. Rotate along the bifurcation plane</span>
<span class="sd">    spanned by two vectors, preserving the angle with</span>
<span class="sd">    the rest of the vasculature. Rotation is performed</span>
<span class="sd">    using a standard rotational matrix. </span>

<span class="sd">    Args:</span>
<span class="sd">        patch_cl (vtkPolyData): Clipped centerline representing two daughter branches.</span>
<span class="sd">        div_points (ndarray): Contains bifurcation landmarking points. </span>
<span class="sd">        rotation_matrix (dict): Cointains rotation matrices for each daughter branch.</span>
<span class="sd">        R (ndarray): Matrix containing unit vectors in the rotated coordinate system.</span>
<span class="sd">    Returns:</span>
<span class="sd">        centerlin (vtkPolyData): Rotated centerline. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkMath</span><span class="o">.</span><span class="n">Distance2BetweenPoints</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">R_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
    
    <span class="n">numberOfPoints</span> <span class="o">=</span> <span class="n">patch_cl</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span>

    <span class="n">centerline</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">()</span>
    <span class="n">centerlinePoints</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPoints</span><span class="p">()</span>
    <span class="n">centerlineCellArray</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCellArray</span><span class="p">()</span>
    <span class="n">radiusArray</span> <span class="o">=</span> <span class="n">get_vtk_array</span><span class="p">(</span><span class="n">radiusArrayName</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numberOfPoints</span><span class="p">)</span>

    <span class="n">line0</span> <span class="o">=</span> <span class="n">extract_single_line</span><span class="p">(</span><span class="n">patch_cl</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">locator0</span> <span class="o">=</span> <span class="n">get_locator</span><span class="p">(</span><span class="n">line0</span><span class="p">)</span>

    <span class="c1"># Iterate through points along the centerline </span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">patch_cl</span><span class="o">.</span><span class="n">GetNumberOfCells</span><span class="p">()):</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">extract_single_line</span><span class="p">(</span><span class="n">patch_cl</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">centerlineCellArray</span><span class="o">.</span><span class="n">InsertNextCell</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">())</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">line0</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">locator0</span><span class="o">.</span><span class="n">FindClosestPoint</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">distance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">dist</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">divergingRatioToSpacingTolerance</span>

        <span class="k">if</span> <span class="n">test</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">div_points</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">locator</span> <span class="o">=</span> <span class="n">get_locator</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>

            <span class="n">pnt1</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">locator</span><span class="o">.</span><span class="n">FindClosestPoint</span><span class="p">(</span><span class="n">div_points</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">pnt2</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">locator</span><span class="o">.</span><span class="n">FindClosestPoint</span><span class="p">(</span><span class="n">div_points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">dist1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">distance</span><span class="p">(</span><span class="n">pnt1</span><span class="p">,</span> <span class="n">div_points</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">dist2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">distance</span><span class="p">(</span><span class="n">pnt2</span><span class="p">,</span> <span class="n">div_points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">k</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="k">if</span> <span class="n">dist1</span> <span class="o">&lt;</span> <span class="n">dist2</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">O</span> <span class="o">=</span> <span class="n">div_points</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">I</span>
            <span class="n">O</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        
        <span class="n">getData</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">radiusArrayName</span><span class="p">)</span><span class="o">.</span><span class="n">GetTuple1</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()):</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">point</span> <span class="o">-</span> <span class="n">O</span><span class="p">,</span> <span class="n">R</span><span class="p">),</span> <span class="n">m</span><span class="p">),</span> <span class="n">R_inv</span><span class="p">)</span> <span class="o">+</span> <span class="n">O</span>
            <span class="n">centerlinePoints</span><span class="o">.</span><span class="n">InsertNextPoint</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">radiusArray</span><span class="o">.</span><span class="n">SetTuple1</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">getData</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
            <span class="n">centerlineCellArray</span><span class="o">.</span><span class="n">InsertCellPoint</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">centerline</span><span class="o">.</span><span class="n">SetPoints</span><span class="p">(</span><span class="n">centerlinePoints</span><span class="p">)</span>
    <span class="n">centerline</span><span class="o">.</span><span class="n">SetLines</span><span class="p">(</span><span class="n">centerlineCellArray</span><span class="p">)</span>
    <span class="n">centerline</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">radiusArray</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">centerline</span></div>


<div class="viewcode-block" id="rotationMatrix"><a class="viewcode-back" href="../scripts.html#move_branches.rotationMatrix">[docs]</a><span class="k">def</span> <span class="nf">rotationMatrix</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">leave1</span><span class="p">,</span> <span class="n">leave2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the rotation matrices for one or both</span>
<span class="sd">    daughter brances of the vessel.</span>

<span class="sd">    Args:</span>
<span class="sd">        data  (dict): Contains information about landmarking points.</span>
<span class="sd">        angle (float): Angle which brances are rotated.</span>
<span class="sd">        leave1 (bool): Leaves first daughter branch if True.</span>
<span class="sd">        leave2 (bool): Leaves second daughter branch if True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        R (ndarray): Matrix containing unit vectors in the rotated coordinate system.</span>
<span class="sd">    Returns:</span>
<span class="sd">        m (dict): Cointains rotation matrices for each daughter branch.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Create basis vectors defining bifurcation plane</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;div_point&quot;</span><span class="p">])</span> <span class="o">+</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;div_point&quot;</span><span class="p">])</span> <span class="o">+</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;bif&quot;</span><span class="p">][</span><span class="s2">&quot;div_point&quot;</span><span class="p">]))</span> <span class="o">/</span> <span class="mf">3.</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;end_point&quot;</span><span class="p">])</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="n">d</span>
        <span class="nb">len</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">))</span>
        <span class="n">vec</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">/</span> <span class="nb">len</span>
    
    <span class="c1"># Expand basis to 3D</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">gram_schmidt</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
    
    <span class="c1"># Set up rotation matrices</span>
    <span class="n">cos_a</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">sin_a</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">m1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="n">cos_a</span><span class="p">,</span> <span class="o">-</span><span class="n">sin_a</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                     <span class="p">[</span><span class="n">sin_a</span><span class="p">,</span>  <span class="n">cos_a</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                     <span class="p">[</span>    <span class="mi">0</span><span class="p">,</span>      <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span> <span class="n">cos_a</span><span class="p">,</span> <span class="n">sin_a</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="n">sin_a</span><span class="p">,</span> <span class="n">cos_a</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                     <span class="p">[</span>     <span class="mi">0</span><span class="p">,</span>     <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>

    <span class="n">m</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="n">m1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="n">m2</span><span class="p">}</span>
    <span class="n">tmp1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;div_point&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">d</span>
    <span class="n">tmp2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;div_point&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">d</span>

    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tmp1</span><span class="p">,</span> <span class="n">R</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tmp2</span><span class="p">,</span> <span class="n">R</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="n">m2</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="n">m1</span><span class="p">}</span>
    
    <span class="c1"># Leave one of the branches untouched</span>
    <span class="k">if</span> <span class="n">leave1</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;r_end&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;r_end&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">2</span>
        <span class="n">m</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span>
    <span class="k">if</span> <span class="n">leave2</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;r_end&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;r_end&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">2</span>
        <span class="n">m</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span>

    <span class="k">return</span> <span class="n">R</span><span class="p">,</span> <span class="n">m</span></div>

<div class="viewcode-block" id="get_startpoint"><a class="viewcode-back" href="../scripts.html#move_branches.get_startpoint">[docs]</a><span class="k">def</span> <span class="nf">get_startpoint</span><span class="p">(</span><span class="n">centerline</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds start point of a given centerline.</span>

<span class="sd">    Args:</span>
<span class="sd">        centerline (vtkPolyData): Centerline data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        start_point (vtkPoint): Start point of centerline.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">extract_single_line</span><span class="p">(</span><span class="n">centerline</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">start_point</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">start_point</span></div>

<div class="viewcode-block" id="merge_cl"><a class="viewcode-back" href="../scripts.html#move_branches.merge_cl">[docs]</a><span class="k">def</span> <span class="nf">merge_cl</span><span class="p">(</span><span class="n">centerline</span><span class="p">,</span> <span class="n">end_point</span><span class="p">,</span> <span class="n">div_point</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge overlapping centerliens.</span>

<span class="sd">    Args:</span>
<span class="sd">        centerline (vtkPolyData): Centerline data consisting of multiple lines.</span>
<span class="sd">        end_point (ndarray): Point where bifurcation ends.</span>
<span class="sd">        div_point (ndarray): Point where centerlines diverge. </span>

<span class="sd">    Returns: </span>
<span class="sd">        merge (vtkPolyData): Merged centerline. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">merge</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">()</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPoints</span><span class="p">()</span>
    <span class="n">cellArray</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCellArray</span><span class="p">()</span>
    <span class="n">N_lines</span> <span class="o">=</span> <span class="n">centerline</span><span class="o">.</span><span class="n">GetNumberOfLines</span><span class="p">()</span>

    <span class="n">arrays</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">N_</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="n">get_number_of_arrays</span><span class="p">(</span><span class="n">centerline</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">centerline</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">tmp_comp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">GetNumberOfComponents</span><span class="p">()</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">get_vtk_array</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tmp_comp</span><span class="p">,</span> <span class="n">centerline</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">())</span>
        <span class="n">arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>

    <span class="c1"># Find lines to merge</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">extract_single_line</span><span class="p">(</span><span class="n">centerline</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_lines</span><span class="p">)]</span>
    <span class="n">locators</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_locator</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_lines</span><span class="p">)]</span>
    <span class="n">div_ID</span> <span class="o">=</span> <span class="p">[</span><span class="n">locators</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">FindClosestPoint</span><span class="p">(</span><span class="n">div_point</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_lines</span><span class="p">)]</span>
    <span class="n">end_ID</span> <span class="o">=</span> <span class="p">[</span><span class="n">locators</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">FindClosestPoint</span><span class="p">(</span><span class="n">end_point</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_lines</span><span class="p">)]</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">end_ID</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">end_point</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_lines</span><span class="p">)]</span>

    <span class="c1"># Find the direction of each line</span>
    <span class="n">map_other</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="n">ID0</span> <span class="o">=</span> <span class="n">locators</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">FindClosestPoint</span><span class="p">(</span><span class="n">end_point</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ID1</span> <span class="o">=</span> <span class="n">locators</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">FindClosestPoint</span><span class="p">(</span><span class="n">end_point</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">dist0</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">ID0</span><span class="p">))</span> <span class="o">-</span> <span class="n">end_point</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">dist1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">ID1</span><span class="p">))</span> <span class="o">-</span> <span class="n">end_point</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">end1</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">dist0</span> <span class="o">&lt;</span> <span class="n">dist1</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="n">end2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="ow">not</span> <span class="n">end1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">N_lines</span><span class="p">):</span>
        <span class="n">ID1</span> <span class="o">=</span> <span class="n">locators</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">FindClosestPoint</span><span class="p">(</span><span class="n">end_point</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ID2</span> <span class="o">=</span> <span class="n">locators</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">FindClosestPoint</span><span class="p">(</span><span class="n">end_point</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">dist1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">ID1</span><span class="p">))</span> <span class="o">-</span> <span class="n">end_point</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">dist2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">ID2</span><span class="p">))</span> <span class="o">-</span> <span class="n">end_point</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">map_other</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">end1</span> <span class="k">if</span> <span class="n">dist1</span> <span class="o">&gt;</span> <span class="n">dist2</span> <span class="k">else</span> <span class="n">end2</span>

    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">centerline</span><span class="o">.</span><span class="n">GetNumberOfLines</span><span class="p">()):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Check if it should be merged</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">get_locator</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">clipp_id</span> <span class="o">=</span> <span class="n">loc</span><span class="o">.</span><span class="n">FindClosestPoint</span><span class="p">(</span><span class="n">end_point</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">div_id</span> <span class="o">=</span> <span class="n">loc</span><span class="o">.</span><span class="n">FindClosestPoint</span><span class="p">(</span><span class="n">div_point</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">clipp_dist</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">clipp_id</span><span class="p">),</span> <span class="n">end_point</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">div_dist</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">div_id</span><span class="p">),</span> <span class="n">div_point</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="n">get_tolerance</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span>
        <span class="n">merge_bool</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">clipp_dist</span> <span class="o">&gt;</span> <span class="n">tol</span> <span class="ow">or</span> <span class="n">div_dist</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="n">merge_bool</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># Get the other line</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">map_other</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span>
        <span class="n">cellArray</span><span class="o">.</span><span class="n">InsertNextCell</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="c1"># Add point</span>
            <span class="k">if</span> <span class="n">div_ID</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">end_ID</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">merge_bool</span><span class="p">:</span> <span class="c1"># and i in change:</span>
                <span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">j</span><span class="p">))</span> <span class="o">+</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">j</span><span class="p">)))</span> <span class="o">/</span> <span class="mf">2.</span>
                <span class="n">points</span><span class="o">.</span><span class="n">InsertNextPoint</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">points</span><span class="o">.</span><span class="n">InsertNextPoint</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>

            <span class="n">cellArray</span><span class="o">.</span><span class="n">InsertCellPoint</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>

            <span class="c1"># Add array</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_</span><span class="p">):</span>
                <span class="n">num</span> <span class="o">=</span> <span class="n">arrays</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">GetNumberOfComponents</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">GetTuple1</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="n">arrays</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">SetTuple1</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">GetTuple3</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="n">arrays</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">SetTuple3</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Add more options&quot;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Insert points, lines and arrays</span>
    <span class="n">merge</span><span class="o">.</span><span class="n">SetPoints</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">merge</span><span class="o">.</span><span class="n">SetLines</span><span class="p">(</span><span class="n">cellArray</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_</span><span class="p">):</span>
        <span class="n">merge</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">arrays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">merge</span></div>

<div class="viewcode-block" id="sort_outlets"><a class="viewcode-back" href="../scripts.html#move_branches.sort_outlets">[docs]</a><span class="k">def</span> <span class="nf">sort_outlets</span><span class="p">(</span><span class="n">outlets</span><span class="p">,</span> <span class="n">outlet1</span><span class="p">,</span> <span class="n">outlet2</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sort all outlets of the geometry given the two relevant outlets</span>

<span class="sd">    Args:</span>
<span class="sd">        outlets (list): List of outlet center points.</span>
<span class="sd">        outlet1 (list): Point representing first relevant oultet. </span>
<span class="sd">        outlet2 (list): Point representing second relevant oultet. </span>
<span class="sd">        dirpath (str): Location of info file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        outlets (list): List of sorted outlet center points.</span>
<span class="sd">    Returns: </span>
<span class="sd">        outlet1 (list): Point representing first relevant oultet. </span>
<span class="sd">    Returns:</span>
<span class="sd">        outlet2 (list): Point representing second relevant oultet. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tmp_outlets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">outlets</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outlets</span><span class="p">)</span><span class="o">//</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">outlet1_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">tmp_outlets</span> <span class="o">-</span> <span class="n">outlet1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">outlet2_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">tmp_outlets</span> <span class="o">-</span> <span class="n">outlet2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tmp_outlets</span> <span class="o">=</span> <span class="n">tmp_outlets</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">outlet1_index</span><span class="p">,</span> <span class="n">outlet2_index</span><span class="p">)</span> <span class="o">==</span> <span class="n">outlet1_index</span><span class="p">:</span>
        <span class="n">outlet1</span> <span class="o">=</span> <span class="n">tmp_outlets</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">outlet1_index</span><span class="p">)</span>
        <span class="n">outlet2</span> <span class="o">=</span> <span class="n">tmp_outlets</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">outlet2_index</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outlet2</span> <span class="o">=</span> <span class="n">tmp_outlets</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">outlet2_index</span><span class="p">)</span>
        <span class="n">outlet1</span> <span class="o">=</span> <span class="n">tmp_outlets</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">outlet1_index</span><span class="p">)</span>
    <span class="n">outlet_rest</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tmp_outlets</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">outlets</span> <span class="o">=</span> <span class="n">outlet1</span> <span class="o">+</span> <span class="n">outlet2</span> <span class="o">+</span> <span class="n">outlet_rest</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outlets</span><span class="p">)</span><span class="o">//</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;outlet&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">outlets</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">write_parameters</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">outlets</span><span class="p">,</span> <span class="n">outlet1</span><span class="p">,</span> <span class="n">outlet2</span></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../scripts.html#move_branches.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">smooth</span><span class="p">,</span> <span class="n">smooth_factor</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">bif</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span>
         <span class="n">cylinder_factor</span><span class="p">,</span> <span class="n">aneurysm</span><span class="p">,</span> <span class="n">anu_num</span><span class="p">,</span> <span class="n">resampling_step</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Objective rotation of daughter branches, by rotating </span>
<span class="sd">    centerlines and Voronoi diagram about the bifuraction center.</span>
<span class="sd">    The implementation is an extension of the original method</span>
<span class="sd">    presented by Ford et al. (2009), for aneurysm removal, </span>
<span class="sd">    which introduces the possibility to rotate the </span>
<span class="sd">    daughter branches a given angle. </span>
<span class="sd">    Includes the option to rotate only one of the daughter branches. </span>

<span class="sd">    Args:</span>
<span class="sd">        dirpath (str): Directory where case folder is located. </span>
<span class="sd">        name (str): Name of directory where case model is located. </span>
<span class="sd">        smooth (bool): Determine if the voronoi diagram should be smoothed.</span>
<span class="sd">        smooth_factor (float): Smoothing factor used for voronoi diagram smoothing.</span>
<span class="sd">        angle (float): Angle which daughter branches are moved, in radians. </span>
<span class="sd">        l1 (bool): Leaves first branch untouched if True.</span>
<span class="sd">        l2 (bool): Leaves second branch untouched if True.</span>
<span class="sd">        bif (bool): Interpolates bifurcation is True.</span>
<span class="sd">        lower (bool): Interpolates a lowered line through the bifurcation if True.</span>
<span class="sd">        cylinder_factor(float): Factor for choosing the smaller cylinder during Voronoi interpolation.</span>
<span class="sd">        aneurysm (bool): Determines if aneurysm is present.</span>
<span class="sd">        anu_num (int): Number of aneurysms.</span>
<span class="sd">        resampling_step (float): Resampling step used to resample centerlines. </span>
<span class="sd">        version (bool): Determines bifurcation interpolation method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Filenames</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Input filenames</span>
    <span class="n">model_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span>  <span class="s2">&quot;.vtp&quot;</span>

    <span class="c1"># Output names</span>
    <span class="c1"># Surface</span>
    <span class="n">model_smoothed_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span> <span class="s2">&quot;_smooth.vtp&quot;</span>

    <span class="c1"># Centerliens</span>
    <span class="n">centerline_par_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span> <span class="s2">&quot;_centerline_par.vtp&quot;</span>
    <span class="n">centerline_aneurysm_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span>  <span class="s2">&quot;_centerline_aneurysm.vtp&quot;</span>
    <span class="n">centerline_bif_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span>  <span class="s2">&quot;_centerline_bif.vtp&quot;</span>
    <span class="n">centerline_complete_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span>  <span class="s2">&quot;_centerline_complete.vtp&quot;</span>
    <span class="n">centerline_clipped_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span>  <span class="s2">&quot;_centerline_clipped_ang.vtp&quot;</span>
    <span class="n">centerline_clipped_bif_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span>  <span class="s2">&quot;_centerline_clipped_bif_ang.vtp&quot;</span>
    <span class="n">centerline_bif_clipped_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span>  <span class="s2">&quot;centerline_clipped_bif_ang.vtp&quot;</span>
    <span class="n">centerline_dau_clipped_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span>  <span class="s2">&quot;centerline_clipped_dau_ang.vtp&quot;</span>
    <span class="n">centerline_new_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span>  <span class="s2">&quot;_centerline_interpolated_ang.vtp&quot;</span>
    <span class="n">centerline_new_bif_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span>  <span class="s2">&quot;_centerline_interpolated_bif_ang.vtp&quot;</span>
    <span class="n">centerline_new_bif_lower_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span>  <span class="s2">&quot;_centerline_interpolated_bif_lower_ang.vtp&quot;</span>
    <span class="n">centerline_relevant_outlets_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span>  <span class="s2">&quot;_centerline_relevant_outlets.vtp&quot;</span>
    <span class="n">centerline_rotated_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span>  <span class="s2">&quot;centerline_rotated_ang.vtp&quot;</span>
    <span class="n">centerline_rotated_bif_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span>  <span class="s2">&quot;centerline_rotated_bif_ang.vtp&quot;</span>
    <span class="n">centerline_rotated_dau_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span>  <span class="s2">&quot;centerline_rotated_dau_ang.vtp&quot;</span>

    <span class="c1"># Voronoi diagrams</span>
    <span class="n">voronoi_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span> <span class="s2">&quot;_voronoi.vtp&quot;</span>
    <span class="n">voronoi_smoothed_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span> <span class="s2">&quot;_voronoi_smoothed.vtp&quot;</span>
    <span class="n">voronoi_clipped_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span> <span class="s2">&quot;_voronoi_clipped_ang.vtp&quot;</span>
    <span class="n">voronoi_ang_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span>  <span class="s2">&quot;_voronoi_ang.vtp&quot;</span>
    <span class="n">voronoi_rotated_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span>  <span class="s2">&quot;voronoi_rotated_ang.vtp&quot;</span>

    <span class="c1"># Points</span>
    <span class="n">points_clipp_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span>  <span class="s2">&quot;_clippingpoints.vtp&quot;</span>
    <span class="n">points_div_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span> <span class="s2">&quot;_divergingpoints.vtp&quot;</span>

    <span class="c1"># Naming based on different options</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;_pi</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">angle</span> <span class="k">if</span> <span class="n">angle</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;_pi</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">angle</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">l1</span> <span class="k">else</span> <span class="s2">&quot;_l1&quot;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">l2</span> <span class="k">else</span> <span class="s2">&quot;_l2&quot;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">bif</span> <span class="k">else</span> <span class="s2">&quot;_bif&quot;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">smooth</span> <span class="k">else</span> <span class="s2">&quot;_smooth&quot;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">lower</span> <span class="k">else</span> <span class="s2">&quot;_lower&quot;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">cylinder_factor</span> <span class="o">==</span> <span class="mf">7.0</span> <span class="k">else</span> <span class="s2">&quot;_cyl</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cylinder_factor</span>
    <span class="n">model_new_surface</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;_angle&quot;</span><span class="o">+</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;.vtp&quot;</span><span class="p">)</span>

    <span class="c1"># Read and check model</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_path</span><span class="p">):</span>
        <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The given directory: </span><span class="si">%s</span><span class="s2"> did not contain the file: model.vtp&quot;</span> <span class="o">%</span> <span class="n">dirpath</span><span class="p">)</span>

    <span class="c1"># Get aneurysm type</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">get_parameters</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;aneurysm_type&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">aneurysm_type</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;aneurysm_type&quot;</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Aneurysm type read from info.txt file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">aneurysm_type</span><span class="p">)</span>

    <span class="c1"># Clean surface</span>
    <span class="n">surface</span> <span class="o">=</span> <span class="n">read_polydata</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
    <span class="n">surface</span> <span class="o">=</span> <span class="n">surface_cleaner</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
    <span class="n">surface</span> <span class="o">=</span> <span class="n">triangulate_surface</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>

   <span class="c1"># Check connectivity and only choose the surface with the largest area</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;check_surface&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">connected_surface</span> <span class="o">=</span> <span class="n">getConnectivity</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;Largest&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">connected_surface</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span> <span class="o">!=</span> <span class="n">surface</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">():</span>
            <span class="n">WritePolyData</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">model_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.vtp&quot;</span><span class="p">,</span> <span class="s2">&quot;_test.vtp&quot;</span><span class="p">))</span>

    <span class="c1"># Get a capped and uncapped version of the surface</span>
    <span class="k">if</span> <span class="n">is_surface_capped</span><span class="p">(</span><span class="n">surface</span><span class="p">):</span>
        <span class="n">open_surface</span> <span class="o">=</span> <span class="n">uncapp_surface</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
        <span class="n">capped_surface</span> <span class="o">=</span> <span class="n">surface</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">open_surface</span> <span class="o">=</span> <span class="n">surface</span>
        <span class="n">capped_surface</span> <span class="o">=</span> <span class="n">capp_surface</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>

    <span class="c1"># Get aneurysm &quot;end point&quot;</span>
    <span class="k">if</span> <span class="n">aneurysm</span><span class="p">:</span>
        <span class="n">aneurysm_point</span> <span class="o">=</span> <span class="n">get_aneurysm_dome</span><span class="p">(</span><span class="n">capped_surface</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">anu_num</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aneurysm_point</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Get inlet and outlets</span>
    <span class="n">outlet1</span><span class="p">,</span> <span class="n">outlet2</span> <span class="o">=</span> <span class="n">get_relevant_outlets</span><span class="p">(</span><span class="n">capped_surface</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">)</span>
    <span class="n">inlet</span><span class="p">,</span> <span class="n">outlets</span> <span class="o">=</span> <span class="n">get_centers</span><span class="p">(</span><span class="n">open_surface</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">)</span>

    <span class="c1"># Sort outlets</span>
    <span class="n">outlets</span><span class="p">,</span> <span class="n">outlet1</span><span class="p">,</span> <span class="n">outlet2</span> <span class="o">=</span> <span class="n">sort_outlets</span><span class="p">(</span><span class="n">outlets</span><span class="p">,</span> <span class="n">outlet1</span><span class="p">,</span> <span class="n">outlet2</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">)</span>

    <span class="c1"># Compute parent artery and aneurysm centerline</span>
    <span class="n">centerline_par</span> <span class="o">=</span> <span class="n">vmtk_compute_centerlines</span><span class="p">(</span><span class="n">inlet</span><span class="p">,</span> <span class="n">outlets</span><span class="p">,</span>
                                          <span class="n">centerline_par_path</span><span class="p">,</span>
                                          <span class="n">capped_surface</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="n">resampling_step</span><span class="p">)</span>
    <span class="n">centerlines_complete</span> <span class="o">=</span> <span class="n">vmtk_compute_centerlines</span><span class="p">(</span><span class="n">inlet</span><span class="p">,</span> <span class="n">outlets</span> <span class="o">+</span> <span class="n">aneurysm_point</span><span class="p">,</span>
                                               <span class="n">centerline_complete_path</span><span class="p">,</span>
                                               <span class="n">capped_surface</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="n">resampling_step</span><span class="p">)</span>

    <span class="c1"># Additional centerline for bifurcation</span>
    <span class="n">centerline_relevant_outlets</span> <span class="o">=</span> <span class="n">vmtk_compute_centerlines</span><span class="p">(</span><span class="n">inlet</span><span class="p">,</span> <span class="n">outlet1</span> <span class="o">+</span> <span class="n">outlet2</span><span class="p">,</span>
                                                          <span class="n">centerline_relevant_outlets_path</span><span class="p">,</span>
                                                          <span class="n">capped_surface</span><span class="p">,</span>
                                                          <span class="n">resampling</span><span class="o">=</span><span class="n">resampling_step</span><span class="p">)</span>
    <span class="n">centerline_bif</span> <span class="o">=</span> <span class="n">vmtk_compute_centerlines</span><span class="p">(</span><span class="n">outlet1</span><span class="p">,</span> <span class="n">outlet2</span><span class="p">,</span>
                                         <span class="n">centerline_bif_path</span><span class="p">,</span>
                                         <span class="n">capped_surface</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="n">resampling_step</span><span class="p">)</span>

    <span class="c1"># Create a tolerance for diverging</span>
    <span class="n">tolerance</span> <span class="o">=</span> <span class="n">get_tolerance</span><span class="p">(</span><span class="n">centerline_par</span><span class="p">)</span>

    <span class="c1"># Get data from centerlines and rotation matrix</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">centerline_relevant_outlets</span><span class="p">,</span> <span class="n">centerline_bif</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">)</span>
    <span class="n">R</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">rotationMatrix</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">)</span> 
    <span class="n">write_parameters</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">)</span>

    <span class="c1"># Compute and smooth voornoi diagram (not aneurysm)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Compute voronoi diagram&quot;</span><span class="p">)</span>
    <span class="n">voronoi</span> <span class="o">=</span> <span class="n">make_voronoi_diagram</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">voronoi_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">voronoi_smoothed_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">smooth</span><span class="p">:</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">get_parameters</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>
        <span class="n">number_of_aneurysms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;aneurysm_&quot;</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">number_of_aneurysms</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">voronoi_smoothed</span> <span class="o">=</span> <span class="n">SmoothClippedVoronoiDiagram</span><span class="p">(</span><span class="n">voronoi</span><span class="p">,</span> <span class="n">centerline_par</span><span class="p">,</span> <span class="n">smooth_factor</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aneu_centerline</span> <span class="o">=</span> <span class="n">extract_single_line</span><span class="p">(</span><span class="n">centerline_complete</span><span class="p">,</span>
                                                <span class="n">centerline_complete</span><span class="o">.</span><span class="n">GetNumberOfCells</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">div_aneu_id</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">centerline_complete</span><span class="o">.</span><span class="n">GetNumberOfCells</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">div_aneu_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">centerline_div</span><span class="p">(</span><span class="n">aneu_centerline</span><span class="p">,</span>
                                                  <span class="n">extract_single_line</span><span class="p">(</span><span class="n">centerline_complete</span><span class="p">,</span> <span class="n">i</span><span class="p">)))</span>
            <span class="n">div_aneu_id</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">div_aneu_id</span><span class="p">)</span>
            <span class="n">aneu_centerline</span> <span class="o">=</span> <span class="n">extract_single_line</span><span class="p">(</span><span class="n">aneu_centerline</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">div_aneu_id</span><span class="p">)</span>
            <span class="n">voronoi_smoothed</span> <span class="o">=</span> <span class="n">SmoothClippedVoronoiDiagram</span><span class="p">(</span><span class="n">voronoi</span><span class="p">,</span>
                                                          <span class="n">centerline_par</span><span class="p">,</span> <span class="n">smooth_factor</span><span class="p">,</span>
                                                          <span class="n">no_smooth</span><span class="o">=</span><span class="n">aneu_centerline</span><span class="p">)</span>

        <span class="n">voronoi_smoothed</span> <span class="o">=</span> <span class="n">remove_extreme_points</span><span class="p">(</span><span class="n">voronoi_smoothed</span><span class="p">,</span> <span class="n">voronoi</span><span class="p">)</span>
        <span class="n">write_polydata</span><span class="p">(</span><span class="n">voronoi_smoothed</span><span class="p">,</span> <span class="n">voronoi_smoothed_path</span><span class="p">)</span>

        <span class="n">surface_smoothed</span> <span class="o">=</span> <span class="n">create_new_surface</span><span class="p">(</span><span class="n">voronoi_smoothed</span><span class="p">)</span>
        <span class="n">write_polydata</span><span class="p">(</span><span class="n">surface_smoothed</span><span class="p">,</span> <span class="n">model_smoothed_path</span><span class="p">)</span>

    <span class="n">voronoi</span> <span class="o">=</span> <span class="n">voronoi</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">smooth</span> <span class="k">else</span> <span class="n">read_polydata</span><span class="p">(</span><span class="n">voronoi_smoothed_path</span><span class="p">)</span>

    <span class="c1"># Locate divpoints and endpoints, for bif or lower, rotated or not</span>
    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;div_point&quot;</span>
    <span class="n">div_points</span> <span class="o">=</span> <span class="n">get_points</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">rotated</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">bif</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">div_points_rotated</span> <span class="o">=</span> <span class="n">get_points</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">rotated</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">bif</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">div_points_rotated_bif</span> <span class="o">=</span> <span class="n">get_points</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">rotated</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">bif</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;end_point&quot;</span>
    <span class="n">end_points</span> <span class="o">=</span> <span class="n">get_points</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">rotated</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">bif</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">end_points_rotated</span> <span class="o">=</span> <span class="n">get_points</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">rotated</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">bif</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">end_points_bif</span> <span class="o">=</span> <span class="n">get_points</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">rotated</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">bif</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">end_points_rotated_bif</span> <span class="o">=</span> <span class="n">get_points</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">rotated</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">bif</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">write_points</span><span class="p">(</span><span class="n">div_points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">points_div_path</span><span class="p">)</span>
    <span class="n">write_points</span><span class="p">(</span><span class="n">end_points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">points_clipp_path</span><span class="p">)</span>

    <span class="c1"># Clip centerlines </span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Clipping centerlines and voronoi diagram.&quot;</span><span class="p">)</span>
    <span class="n">patch_cl</span> <span class="o">=</span> <span class="n">CreateParentArteryPatches</span><span class="p">(</span><span class="n">centerline_par</span><span class="p">,</span> <span class="n">end_points</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">write_polydata</span><span class="p">(</span><span class="n">patch_cl</span><span class="p">,</span> <span class="n">centerline_clipped_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lower</span> <span class="ow">or</span> <span class="n">bif</span><span class="p">:</span>
        <span class="n">patch_bif_cl</span> <span class="o">=</span> <span class="n">CreateParentArteryPatches</span><span class="p">(</span><span class="n">centerline_bif</span><span class="p">,</span> <span class="n">end_points_bif</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">write_polydata</span><span class="p">(</span><span class="n">patch_bif_cl</span><span class="p">,</span> <span class="n">centerline_clipped_bif_path</span><span class="p">)</span>

    <span class="c1"># Clip the voronoi diagram</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Clipping the Voronoi diagram&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">voronoi_clipped_path</span><span class="p">):</span>
        <span class="n">voronoi_clipped</span> <span class="o">=</span> <span class="n">read_polydata</span><span class="p">(</span><span class="n">voronoi_clipped_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">masked_voronoi</span> <span class="o">=</span> <span class="n">MaskVoronoiDiagram</span><span class="p">(</span><span class="n">voronoi</span><span class="p">,</span> <span class="n">patch_cl</span><span class="p">)</span>
        <span class="n">voronoi_clipped</span> <span class="o">=</span> <span class="n">ExtractMaskedVoronoiPoints</span><span class="p">(</span><span class="n">voronoi</span><span class="p">,</span> <span class="n">masked_voronoi</span><span class="p">)</span>
        <span class="n">write_polydata</span><span class="p">(</span><span class="n">voronoi_clipped</span><span class="p">,</span> <span class="n">voronoi_clipped_path</span><span class="p">)</span>

    <span class="c1"># Rotate branches (Centerline and Voronoi diagram) </span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Rotate centerlines and voronoi diagram.&quot;</span><span class="p">)</span>
    <span class="n">rotated_cl</span> <span class="o">=</span> <span class="n">rotate_cl</span><span class="p">(</span><span class="n">patch_cl</span><span class="p">,</span> <span class="n">end_points</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">m</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
    <span class="n">write_polydata</span><span class="p">(</span><span class="n">rotated_cl</span><span class="p">,</span> <span class="n">centerline_rotated_path</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">lower</span> <span class="ow">or</span> <span class="n">bif</span><span class="p">:</span>
        <span class="n">rotated_bif_cl</span> <span class="o">=</span> <span class="n">rotate_cl</span><span class="p">(</span><span class="n">patch_bif_cl</span><span class="p">,</span> <span class="n">end_points_bif</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">m</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
        <span class="n">write_polydata</span><span class="p">(</span><span class="n">rotated_bif_cl</span><span class="p">,</span> <span class="n">centerline_rotated_bif_path</span><span class="p">)</span>
    
    <span class="n">rotated_voronoi</span> <span class="o">=</span> <span class="n">rotate_voronoi</span><span class="p">(</span><span class="n">voronoi_clipped</span><span class="p">,</span> <span class="n">patch_cl</span><span class="p">,</span> <span class="n">end_points</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">m</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
    <span class="n">write_polydata</span><span class="p">(</span><span class="n">rotated_voronoi</span><span class="p">,</span> <span class="n">voronoi_rotated_path</span><span class="p">)</span>


    <span class="c1"># Interpolate the centerline</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Interpolate centerlines and voronoi diagram.&quot;</span><span class="p">)</span>
    <span class="n">interpolated_cl</span> <span class="o">=</span> <span class="n">InterpolatePatchCenterlines</span><span class="p">(</span><span class="n">rotated_cl</span><span class="p">,</span> <span class="n">centerline_par</span><span class="p">,</span>
                                                  <span class="n">div_points_rotated</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                                                  <span class="bp">None</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">write_polydata</span><span class="p">(</span><span class="n">interpolated_cl</span><span class="p">,</span> <span class="n">centerline_new_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.vtp&quot;</span><span class="p">,</span> <span class="s2">&quot;1.vtp&quot;</span><span class="p">))</span>


    <span class="k">if</span> <span class="n">bif</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Start interpolate bif&quot;</span><span class="p">)</span>
        <span class="n">interpolated_bif</span> <span class="o">=</span> <span class="n">InterpolatePatchCenterlines</span><span class="p">(</span><span class="n">rotated_bif_cl</span><span class="p">,</span> <span class="n">centerline_bif</span><span class="p">,</span>
                                                        <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;bif&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">write_polydata</span><span class="p">(</span><span class="n">interpolated_bif</span><span class="p">,</span> <span class="n">centerline_new_bif_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lower</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Start interpolate lower&quot;</span><span class="p">)</span>
        <span class="n">center</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">/</span><span class="mf">9.</span><span class="p">)</span><span class="o">*</span><span class="n">div_points</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mf">9.</span><span class="p">)</span><span class="o">*</span><span class="n">div_points</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                        <span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mf">9.</span><span class="p">)</span><span class="o">*</span><span class="n">div_points</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">div_points_rotated_bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">SetPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">interpolated_bif_lower</span> <span class="o">=</span> <span class="n">InterpolatePatchCenterlines</span><span class="p">(</span><span class="n">rotated_bif_cl</span><span class="p">,</span> <span class="n">centerline_bif</span><span class="p">,</span>
                                                             <span class="n">div_points_rotated_bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                                                             <span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">write_polydata</span><span class="p">(</span><span class="n">interpolated_bif_lower</span><span class="p">,</span> <span class="n">centerline_new_bif_lower_path</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Start merge&quot;</span><span class="p">)</span>
    <span class="n">interpolated_cl</span> <span class="o">=</span> <span class="n">merge_cl</span><span class="p">(</span><span class="n">interpolated_cl</span><span class="p">,</span> <span class="n">div_points_rotated</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">end_points_rotated</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">write_polydata</span><span class="p">(</span><span class="n">interpolated_cl</span><span class="p">,</span> <span class="n">centerline_new_path</span><span class="p">)</span>

    <span class="n">bif_</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">lower</span> <span class="ow">and</span> <span class="n">bif</span><span class="p">:</span>
        <span class="n">bif_</span> <span class="o">=</span> <span class="p">[</span><span class="n">interpolated_bif</span><span class="p">,</span> <span class="n">interpolated_bif_lower</span><span class="p">,</span> <span class="n">rotated_bif_cl</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">bif</span><span class="p">:</span>
        <span class="n">bif_</span> <span class="o">=</span> <span class="p">[</span><span class="n">interpolated_bif</span><span class="p">,</span> <span class="n">rotated_bif_cl</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">lower</span><span class="p">:</span>
        <span class="n">bif_</span> <span class="o">=</span> <span class="p">[</span><span class="n">interpolated_bif_lower</span><span class="p">,</span> <span class="n">rotated_bif_cl</span><span class="p">]</span>

    <span class="c1"># Interpolate voronoi diagram</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Start interpolate voronoi diagram&quot;</span><span class="p">)</span>
    <span class="n">interpolated_voronoi</span> <span class="o">=</span> <span class="n">interpolate_voronoi_diagram</span><span class="p">(</span><span class="n">interpolated_cl</span><span class="p">,</span> <span class="n">rotated_cl</span><span class="p">,</span>
                                                       <span class="n">rotated_voronoi</span><span class="p">,</span>
                                                       <span class="n">end_points_rotated</span><span class="p">,</span>
                                                       <span class="n">bif_</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">cylinder_factor</span><span class="p">)</span>

    <span class="n">write_polydata</span><span class="p">(</span><span class="n">interpolated_voronoi</span><span class="p">,</span> <span class="n">voronoi_ang_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.vtp&quot;</span><span class="p">,</span> <span class="s2">&quot;_remove.vtp&quot;</span><span class="p">))</span>
    <span class="n">interpolated_voronoi</span> <span class="o">=</span> <span class="n">remove_distant_points</span><span class="p">(</span><span class="n">interpolated_voronoi</span><span class="p">,</span> <span class="n">interpolated_cl</span><span class="p">)</span>
    <span class="n">write_polydata</span><span class="p">(</span><span class="n">interpolated_voronoi</span><span class="p">,</span> <span class="n">voronoi_ang_path</span><span class="p">)</span>

    <span class="c1"># Write a new surface from the new voronoi diagram</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Create new surface&quot;</span><span class="p">)</span>
    <span class="n">new_surface</span> <span class="o">=</span> <span class="n">create_new_surface</span><span class="p">(</span><span class="n">interpolated_voronoi</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Surface saved in: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_new_surface</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">write_polydata</span><span class="p">(</span><span class="n">new_surface</span><span class="p">,</span> <span class="n">model_new_surface</span><span class="p">)</span></div>



<span class="k">if</span>  <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">smooth</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">smooth_factor</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">bif</span><span class="p">,</span> <span class="n">basedir</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> \
    <span class="n">cylinder_factor</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">aneurysm</span><span class="p">,</span> <span class="n">anu_num</span><span class="p">,</span> <span class="n">resampling_step</span> <span class="o">=</span> <span class="n">read_command_line</span><span class="p">()</span>
    <span class="n">folders</span> <span class="o">=</span> <span class="n">listdir</span><span class="p">(</span><span class="n">basedir</span><span class="p">)</span> <span class="k">if</span> <span class="n">case</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">case</span><span class="p">]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;surface/model&quot;</span>
    <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">folder</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;P0&quot;</span><span class="p">,</span> <span class="s2">&quot;C0&quot;</span><span class="p">]:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Working on case&quot;</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
            <span class="n">main</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="n">smooth</span><span class="p">,</span> <span class="n">smooth_factor</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span>
                  <span class="n">l2</span><span class="p">,</span> <span class="n">bif</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">cylinder_factor</span><span class="p">,</span> <span class="n">aneurysm</span><span class="p">,</span> <span class="n">anu_num</span><span class="p">,</span> <span class="n">resampling_step</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Aslak Bergersen &amp; Henrik Kjeldsberg.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>